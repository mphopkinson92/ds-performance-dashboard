<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DS Performance Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS VARIABLES & BASE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#FFF6D8;--card:#fff;--text:#522A10;--text2:#888;--border:rgba(82,42,16,.1);
  --hdr:#522A10;--hdr-t:#FFE180;
  --bud:#10507C;--fcst:#522A10;--act:#ED6961;
  --pos:#4CAF50;--neg:#ED6961;
}
.theme-marro {
  --bg:#FDF5F5;--text:#2D2D2D;--border:rgba(128,2,15,.08);
  --hdr:#80020F;--hdr-t:#fff;
  --bud:#80020F;--fcst:#DABFBD;--act:#C88131;
}
.theme-combined {
  --bg:#F9F6F0;--text:#2D2D2D;--border:rgba(0,0,0,.06);
  --hdr:#3A3A3A;--hdr-t:#fff;
  --bud:#10507C;--fcst:#9BC3FE;--act:#522A10;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background .3s}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOP BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.top{background:var(--hdr);color:var(--hdr-t);padding:10px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.15)}
.top h1{font-size:15px;font-weight:700}
.top-ctrls{display:flex;align-items:center;gap:10px}
.top-ctrls select,.top-ctrls button{padding:5px 10px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.1);color:var(--hdr-t)}
.top-ctrls select option{color:#333;background:#fff}
.brand-btn{border:none!important;opacity:.65;transition:all .2s}
.brand-btn.active{opacity:1;background:rgba(255,255,255,.25)!important}
.refresh-btn{background:rgba(255,255,255,.2)!important;border:none!important}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs{display:flex;background:var(--card);border-bottom:2px solid var(--border);overflow-x:auto}
.tab-btn{padding:11px 22px;border:none;background:0;cursor:pointer;font-size:13px;font-weight:600;color:var(--text2);border-bottom:3px solid transparent;white-space:nowrap;transition:all .2s}
.tab-btn:hover{color:var(--text)}
.tab-btn.active{color:var(--bud);border-bottom-color:var(--bud)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.content{max-width:1440px;margin:0 auto;padding:20px 24px 60px}
.tab-page{display:none}.tab-page.active{display:block}
.section-hdr{display:flex;align-items:center;gap:10px;margin:20px 0 12px}
.section-hdr h2{font-size:15px;font-weight:700}
.section-hdr .line{flex:1;height:2px;background:var(--border)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KPI CARDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.kpi-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
.kpi{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 2px 10px var(--border);flex:1 1 200px;min-width:180px;position:relative;overflow:hidden;transition:transform .2s}
.kpi:hover{transform:translateY(-2px)}
.kpi .stripe{position:absolute;top:0;left:0;right:0;height:4px}
.kpi .icon{position:absolute;top:12px;right:14px;font-size:18px;opacity:.35}
.kpi .label{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);font-weight:600;margin-bottom:4px}
.kpi .value{font-size:24px;font-weight:800;color:var(--text)}
.kpi .compare{font-size:11px;color:var(--text2);margin-top:4px}
.kpi .compare b{font-weight:600}
.kpi .var{font-size:12px;font-weight:700;margin-top:3px}
.kpi .var.pos{color:var(--pos)}.kpi .var.neg{color:var(--neg)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chart-row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}
.chart-card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 2px 10px var(--border);flex:1 1 48%;min-width:320px}
.chart-card.full{flex:1 1 100%}
.chart-card h3{font-size:13px;font-weight:700;margin-bottom:10px}
.chart-wrap{position:relative;height:340px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tbl-wrap{background:var(--card);border-radius:10px;box-shadow:0 2px 10px var(--border);overflow:hidden;margin-bottom:16px}
.tbl-wrap h3{padding:14px 16px 8px;font-size:13px;font-weight:700}
.tbl-wrap .scroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{background:var(--hdr);color:var(--hdr-t);padding:8px 12px;font-weight:600;white-space:nowrap;text-align:right;position:sticky;top:0}
thead th:first-child{text-align:left}
tbody td{padding:7px 12px;text-align:right;border-bottom:1px solid var(--border)}
tbody td:first-child{text-align:left;font-weight:600}
tbody tr:hover{background:rgba(0,0,0,.02)}
.pos{color:var(--pos);font-weight:600}.neg{color:var(--neg);font-weight:600}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BRAND PANELS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.brand-split{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}
.brand-col{flex:1 1 48%;min-width:300px;border-radius:10px;overflow:hidden;box-shadow:0 2px 10px var(--border)}
.brand-col-hdr{padding:10px 16px;font-weight:700;font-size:14px}
.brand-col-hdr.bbn{background:#FFD54D;color:#522A10}
.brand-col-hdr.mro{background:#80020F;color:#fff}
.brand-col-body{background:var(--card);padding:14px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REGION CARDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.region-grid{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
.region-card{background:var(--card);border-radius:10px;padding:14px 18px;text-align:center;box-shadow:0 2px 8px var(--border);min-width:130px;flex:1 1 auto;border-left:4px solid var(--bud)}
.region-card .rname{font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text2);letter-spacing:.5px}
.region-card .rval{font-size:22px;font-weight:800;margin-top:3px}
.region-card .rsub{font-size:10px;color:var(--text2);margin-top:2px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG PANEL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.config{background:var(--card);border-radius:12px;padding:30px;max-width:500px;margin:40px auto;box-shadow:0 4px 24px var(--border)}
.config h2{margin-bottom:16px;font-size:18px}
.config label{display:block;font-size:13px;font-weight:600;color:var(--text2);margin-bottom:4px}
.config input{width:100%;padding:10px 14px;border:2px solid var(--border);border-radius:8px;font-size:14px;margin-bottom:14px}
.config input:focus{outline:none;border-color:var(--bud)}
.config button{width:100%;padding:12px;border:none;border-radius:8px;background:var(--hdr);color:var(--hdr-t);font-weight:700;font-size:15px;cursor:pointer}
.config .hint{font-size:11px;color:var(--text2);margin-top:-10px;margin-bottom:14px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING & RESPONSIVE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.loading{display:flex;align-items:center;justify-content:center;min-height:300px;flex-direction:column;gap:12px}
.spinner{width:36px;height:36px;border:4px solid var(--border);border-top-color:var(--bud);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:900px){.chart-row,.brand-split{flex-direction:column}.kpi-row{flex-wrap:wrap}}
@media(max-width:600px){.kpi{min-width:100%}.tab-btn{padding:9px 14px;font-size:12px}.content{padding:12px}}
@media print{.top,.tabs{position:relative}body{-webkit-print-color-adjust:exact;print-color-adjust:exact}}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOP BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="top">
  <h1 id="title">ğŸ¾ DS Performance Dashboard</h1>
  <div class="top-ctrls">
    <button class="brand-btn active" onclick="setBrand('butternut')">ğŸ¶ BBN</button>
    <button class="brand-btn" onclick="setBrand('marro')">ğŸ± MRO</button>
    <button class="brand-btn" onclick="setBrand('combined')">ğŸ¾ All</button>
    <select id="selView" onchange="onViewChange()" title="View by">
      <option value="week" selected>By Week</option>
      <option value="period">By Period</option>
    </select>
    <select id="selRange" onchange="render()" title="Quarter">
      <option value="ytd">YTD</option>
      <option value="Q1">Q1 (P1-P3)</option>
      <option value="Q2">Q2 (P4-P6)</option>
      <option value="Q3">Q3 (P7-P9)</option>
      <option value="Q4">Q4 (P10-P13)</option>
      <option value="full">Full Year</option>
    </select>
    <select id="selPeriod" onchange="render()"><option value="all">All Periods</option></select>
    <select id="selWeek" onchange="render()"><option value="all">All Weeks</option></select>
    <select id="selRegionGroup" onchange="render()"><option value="all">All Region Groups</option></select>
    <button class="refresh-btn" onclick="loadData()" title="Refresh data">â†»</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TABS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tabs">
  <button class="tab-btn active" onclick="setTab('summary',this)">ğŸ“Š Summary</button>
  <button class="tab-btn" onclick="setTab('sales',this)">ğŸ“ˆ Sales & CPA</button>
  <button class="tab-btn" onclick="setTab('regions',this)">ğŸ—ºï¸ Regional</button>
  <button class="tab-btn" onclick="setTab('team',this)">ğŸ‘¥ Team & Staffing</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="content">
  <!-- Config -->
  <div id="configPanel" class="config" style="display:none">
    <h2>Connect to Airtable</h2>
    <label>Personal Access Token</label>
    <input type="password" id="cfgToken" placeholder="pat...">
    <p class="hint">Create at airtable.com/create/tokens â€” needs data.records:read scope on the Budget Tracking base.</p>
    <button onclick="saveConfig()">Connect & Load Data</button>
  </div>

  <!-- Loading -->
  <div id="loadingEl" class="loading" style="display:none"><div class="spinner"></div><span style="color:var(--text2)">Loading data from Airtable...</span></div>

  <!-- TAB: SUMMARY -->
  <div id="tab-summary" class="tab-page active">
    <div class="section-hdr"><h2 id="summaryTitle">YTD Performance</h2><div class="line"></div></div>
    <div class="kpi-row" id="summaryKPIs"></div>
    <div class="chart-row">
      <div class="chart-card full"><h3>Sales: Budget vs Actual vs Forecast</h3><div class="chart-wrap"><canvas id="cSalesPeriod"></canvas></div></div>
    </div>
    <div class="chart-row">
      <div class="chart-card full"><h3>CPA: Budget vs Actual</h3><div class="chart-wrap"><canvas id="cCPAPeriod"></canvas></div></div>
    </div>
    <div class="chart-row">
      <div class="chart-card full"><h3>Cumulative Spend: Budget vs Actual</h3><div class="chart-wrap"><canvas id="cSpendCum"></canvas></div></div>
    </div>
  </div>

  <!-- TAB: SALES & CPA (by Region Group, stacked by region, weekly) -->
  <div id="tab-sales" class="tab-page">
    <div class="section-hdr"><h2>Sales & CPA by Region Group</h2><div class="line"></div></div>
    <div class="kpi-row" id="salesKPIs"></div>
    <div id="salesRegionCharts"></div>
    <div class="tbl-wrap"><h3>Period Detail</h3><div class="scroll"><table id="tblPeriod"></table></div></div>
  </div>

  <!-- TAB: REGIONAL (summary totals, controlled by range filter) -->
  <div id="tab-regions" class="tab-page">
    <div class="section-hdr"><h2>Regional Summary</h2><div class="line"></div></div>
    <div class="region-grid" id="regionCards"></div>
    <div class="chart-row">
      <div class="chart-card full"><h3>Sales by Region</h3><div class="chart-wrap"><canvas id="cRegSumSales"></canvas></div></div>
    </div>
    <div class="chart-row">
      <div class="chart-card full"><h3>CPA by Region</h3><div class="chart-wrap"><canvas id="cRegSumCPA"></canvas></div></div>
    </div>
    <div class="chart-row">
      <div class="chart-card full"><h3>SPS by Region</h3><div class="chart-wrap"><canvas id="cRegSumSPS"></canvas></div></div>
    </div>
    <div class="chart-row">
      <div class="chart-card full"><h3>Team Size by Region</h3><div class="chart-wrap"><canvas id="cRegSumTeam"></canvas></div></div>
    </div>
  </div>

  <!-- TAB: TEAM -->
  <div id="tab-team" class="tab-page">
    <div class="section-hdr"><h2>Team Size & Staffing</h2><div class="line"></div></div>
    <div class="kpi-row" id="teamKPIs"></div>
    <div id="teamRegionCharts"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BASE_ID = 'appcbUbKvlLayiuo5';
const TABLE_NAME = 'ğŸ“Š Weekly Summary';
const PERIODS = ['P1','P2','P3','P4','P5','P6','P7','P8','P9','P10','P11','P12','P13'];
const P_ORD = Object.fromEntries(PERIODS.map((p,i)=>[p,i+1]));
const WEEKS = Array.from({length:52},(_,i)=>`W${i+1}`);
const W_ORD = Object.fromEntries(WEEKS.map((w,i)=>[w,i+1]));

// Brand colour palettes
const C = {
  butternut: { bud:'#10507C', fcst:'#FFD54D', act:'#ED6961', budA:.4, actA:.8 },
  marro:     { bud:'#10507C', fcst:'#FFD54D', act:'#ED6961', budA:.4, actA:.8 },
  combined:  { bud:'#10507C', fcst:'#FFD54D', act:'#ED6961', budA:.4, actA:.8 },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let STATE = { brand:'combined', records:[], charts:{} };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AIRTABLE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchRecords(token, year) {
  const fields = [
    'âš™ï¸ Year','âš™ï¸ Period','âš™ï¸ Week','âš™ï¸ Region','âš™ï¸ Region Group','âš™ï¸ Market','âš™ï¸ Channel','âš™ï¸ Level',
    'ğŸ”µğŸ¶ Sales','ğŸŸ¡ğŸ¶ Sales','ğŸ”´ğŸ¶ Sales','ğŸ”µğŸ± Sales','ğŸŸ¡ğŸ± Sales','ğŸ”´ğŸ± Sales',
    'ğŸ”µğŸ¶ Spend','ğŸŸ¡ğŸ¶ Spend','ğŸ”´ğŸ¶ Spend','ğŸ”µğŸ± Spend','ğŸŸ¡ğŸ± Spend','ğŸ”´ğŸ± Spend',
    'ğŸ”µğŸ¶ CPA','ğŸŸ¡ğŸ¶ CPA','ğŸ”´ğŸ¶ CPA','ğŸ”µğŸ± CPA','ğŸŸ¡ğŸ± CPA','ğŸ”´ğŸ± CPA',
    'ğŸ”µğŸ¶ SPS','ğŸŸ¡ğŸ¶ SPS','ğŸ”´ğŸ¶ SPS','ğŸ”µğŸ± SPS','ğŸŸ¡ğŸ± SPS','ğŸ”´ğŸ± SPS',
    'ğŸ”´ Rep Team Size','ğŸ”´ BA Team Size','ğŸ”´ Total Team Size','ğŸŸ¡ Team Size Required','ğŸ”µ Rep Team Size p/w',
    'ğŸ”´ Shifts','ğŸŸ¡ Shifts','ğŸ”´ Shift Capacity','ğŸ”´ Staffing Performance','ğŸ”´ Rep Shifts Required',
    'ğŸ¶ Sales Var vs Budget','ğŸ¶ Sales Var % vs Budget','ğŸ± Sales Var vs Budget','ğŸ± Sales Var % vs Budget',
    'ğŸ¶ Spend Var vs Budget','ğŸ± Spend Var vs Budget',
  ];
  const headers = { Authorization: `Bearer ${token}` };
  let all = [], offset = null;
  do {
    let url = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_NAME)}?`;
    url += fields.map(f=>`fields[]=${encodeURIComponent(f)}`).join('&');
    url += `&filterByFormula=${encodeURIComponent(`{âš™ï¸ Year}="${year}"`)}`;
    if (offset) url += `&offset=${offset}`;
    const resp = await fetch(url, { headers });
    if (!resp.ok) throw new Error(`API ${resp.status}: ${resp.statusText}`);
    const json = await resp.json();
    all = all.concat(json.records);
    offset = json.offset;
  } while (offset);
  return all;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gv(r,f){ const v=r.fields[f]; if(v==null) return 0; if(typeof v==='object'&&v.name) return v.name; if(typeof v==='string') return parseFloat(v.replace(/[Â£,]/g,''))||0; return Number(v)||0; }
function gs(r,f){ const v=r.fields[f]; if(!v) return ''; if(typeof v==='object'&&v.name) return v.name; return String(v); }
function sum(recs,f){ return recs.reduce((s,r)=>s+gv(r,f),0); }
function avg(recs,f){ const vals=recs.map(r=>gv(r,f)).filter(v=>v!==0&&v!==null&&!isNaN(v)); return vals.length?vals.reduce((a,b)=>a+b,0)/vals.length:0; }
function wAvg(recs,numF,denF){ const n=sum(recs,numF),d=sum(recs,denF); return d?n/d:0; }

function fmt(n){ return n==null||isNaN(n)?'â€”':Math.round(n).toLocaleString('en-GB'); }
function fmtC(n){ return n==null||isNaN(n)?'â€”':'Â£'+Math.round(n).toLocaleString('en-GB'); }
function fmtCPA(n){ return !n||isNaN(n)?'â€”':'Â£'+n.toFixed(2); }
function fmtP(n){ return n==null||isNaN(n)?'â€”':(n*100).toFixed(1)+'%'; }
function fmtV(n){ if(n==null||isNaN(n)) return 'â€”'; return (n>=0?'+':'')+((n*100).toFixed(1))+'%'; }

// Group records by a field value
function groupBy(recs,f){ const g={}; for(const r of recs){ const k=gs(r,f); if(k){ if(!g[k]) g[k]=[]; g[k].push(r); } } return g; }

// Filter helpers
function applyGlobalFilters(recs) {
  const periodSel = document.getElementById('selPeriod').value;
  const weekSel = document.getElementById('selWeek').value;
  const rgSel = document.getElementById('selRegionGroup').value;
  const range = document.getElementById('selRange').value;

  // Quarter filter
  if (range !== 'full' && range !== 'ytd' && Q_PERIODS[range]) {
    const allowed = new Set(Q_PERIODS[range]);
    recs = recs.filter(r => allowed.has(gs(r,'âš™ï¸ Period')));
  }
  if (range === 'ytd') recs = recs.filter(r => hasActualData([r]));

  // Period filter
  if (periodSel !== 'all') recs = recs.filter(r => gs(r,'âš™ï¸ Period') === periodSel);

  // Week filter
  if (weekSel !== 'all') recs = recs.filter(r => gs(r,'âš™ï¸ Week') === weekSel);

  // Region Group filter
  if (rgSel !== 'all') {
    const regionsInGroup = REG_IN_GROUP[rgSel] || [];
    recs = recs.filter(r => regionsInGroup.includes(gs(r,'âš™ï¸ Region')) || gs(r,'âš™ï¸ Region Group') === rgSel);
  }

  return recs;
}

function getFiltered() {
  // Use Region level for all tabs â€” aggregation happens in JS
  let recs = STATE.records.filter(r => gs(r,'âš™ï¸ Level') === 'Region');
  return applyGlobalFilters(recs);
}

function getPeriodsWithData(recs) {
  const byP = groupBy(recs,'âš™ï¸ Period');
  return PERIODS.filter(p => byP[p] && byP[p].some(r => gv(r,'ğŸ”´ğŸ¶ Sales')>0 || gv(r,'ğŸ”´ğŸ± Sales')>0));
}

// Quarter to period/week mapping
const Q_PERIODS = { Q1:['P1','P2','P3'], Q2:['P4','P5','P6'], Q3:['P7','P8','P9'], Q4:['P10','P11','P12','P13'] };
const Q_WEEKS = { Q1: WEEKS.slice(0,13), Q2: WEEKS.slice(13,26), Q3: WEEKS.slice(26,39), Q4: WEEKS.slice(39,52) };

// Check if a time bucket has actual data (not future/empty)
function hasActualData(recs) {
  return recs.some(r => gv(r,'ğŸ”´ğŸ¶ Sales')>0 || gv(r,'ğŸ”´ğŸ± Sales')>0);
}

// Time axis helper â€” returns { field, labels, grouped } based on view + range
function getTimeAxis(recs) {
  const view = document.getElementById('selView').value;
  const range = document.getElementById('selRange').value;

  const field = view === 'week' ? 'âš™ï¸ Week' : 'âš™ï¸ Period';
  const allLabels = view === 'week' ? WEEKS : PERIODS;
  const grouped = groupBy(recs, field);

  // Filter by quarter range
  let rangeLabels;
  if (range === 'full') {
    rangeLabels = allLabels;
  } else if (Q_PERIODS[range]) {
    rangeLabels = view === 'week' ? Q_WEEKS[range] : Q_PERIODS[range];
  } else {
    // YTD â€” only show labels that have actual data
    rangeLabels = allLabels;
  }

  // Only show labels that exist in data AND (for YTD) have actual data â€” hide future empty weeks
  const labels = rangeLabels.filter(t => {
    if (!grouped[t]) return false;
    if (range === 'ytd' || range === 'full') return hasActualData(grouped[t]);
    return true; // For Q filters, show all weeks in range even if no actuals yet (budget still relevant)
  });

  return { field, labels, grouped };
}

function onViewChange() {
  render();
}

// Get brand-aware field values
function bSales(recs,prefix) {
  const b = STATE.brand;
  if(b==='butternut') return sum(recs,`${prefix}ğŸ¶ Sales`);
  if(b==='marro') return sum(recs,`${prefix}ğŸ± Sales`);
  return sum(recs,`${prefix}ğŸ¶ Sales`) + sum(recs,`${prefix}ğŸ± Sales`);
}
function bSpend(recs,prefix) {
  const b = STATE.brand;
  if(b==='butternut') return sum(recs,`${prefix}ğŸ¶ Spend`);
  if(b==='marro') return sum(recs,`${prefix}ğŸ± Spend`);
  return sum(recs,`${prefix}ğŸ¶ Spend`) + sum(recs,`${prefix}ğŸ± Spend`);
}
function bCPA(recs,prefix) {
  const sales = bSales(recs,prefix), spend = bSpend(recs,prefix);
  return sales > 0 ? spend / sales : 0;
}
function bSPS(recs,prefix) {
  const b = STATE.brand;
  if(b==='butternut') return avg(recs,`${prefix}ğŸ¶ SPS`);
  if(b==='marro') return avg(recs,`${prefix}ğŸ± SPS`);
  return (avg(recs,`${prefix}ğŸ¶ SPS`) + avg(recs,`${prefix}ğŸ± SPS`)) / 2;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KPI CARD BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function kpi(label,value,budLbl,budVal,variance,icon,color,invertVar) {
  const pos = variance!=null ? (invertVar ? variance<=0 : variance>=0) : true;
  return `<div class="kpi"><div class="stripe" style="background:${color}"></div><div class="icon">${icon}</div>
    <div class="label">${label}</div><div class="value">${value}</div>
    ${budLbl?`<div class="compare">${budLbl}: <b>${budVal}</b></div>`:''}
    ${variance!=null?`<div class="var ${pos?'pos':'neg'}">${fmtV(variance)}</div>`:''}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function destroyChart(id) { if(STATE.charts[id]) { STATE.charts[id].destroy(); delete STATE.charts[id]; } }

function shouldShowLabels() {
  // Show data labels when <= 13 data points (period view or quarter), hide for full weekly
  const view = document.getElementById('selView').value;
  const range = document.getElementById('selRange').value;
  if (view === 'period') return true;
  if (range !== 'ytd' && range !== 'full') return true; // quarter = ~13 weeks, ok
  return false; // full year weekly = too many
}

function makeBarChart(id, labels, datasets, opts={}) {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if(!ctx) return;
  const showLbl = shouldShowLabels();
  const dlFmt = opts.yFmt || (v=>fmt(v));
  STATE.charts[id] = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ top:30 } },
      interaction:{ intersect:false, mode:'index' },
      plugins:{
        legend:{ position:'bottom', labels:{ usePointStyle:true, padding:14, font:{size:11,weight:'600'} } },
        datalabels:{ display:showLbl, anchor:'end', align:'top', font:{size:13,weight:'700'}, color:function(ctx){return ctx.dataset.borderColor||ctx.dataset.backgroundColor||'#555'}, formatter: dlFmt },
      },
      scales:{
        x:{ grid:{display:false}, ticks:{font:{size:labels.length>20?8:11}} },
        y:{ beginAtZero:true, ticks:{ callback: opts.yFmt || (v=>fmt(v)) }, grid:{color:'rgba(0,0,0,.04)'} },
      },
    },
    plugins: [ChartDataLabels],
  });
}

function makeLineChart(id, labels, datasets, opts={}) {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if(!ctx) return;
  const showLbl = shouldShowLabels();
  const dlFmt = opts.yFmt || (v=>fmtC(v));
  STATE.charts[id] = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ top:30 } },
      interaction:{ intersect:false, mode:'index' },
      plugins:{
        legend:{ position:'bottom', labels:{ usePointStyle:true, padding:14, font:{size:11,weight:'600'} } },
        datalabels:{ display:showLbl, anchor:'end', align:'top', font:{size:13,weight:'700'}, color:function(ctx){return ctx.dataset.borderColor||'#555'}, formatter: dlFmt },
      },
      scales:{
        x:{ grid:{display:false}, ticks:{font:{size:labels.length>20?8:11}} },
        y:{ beginAtZero: opts.zero!==false, ticks:{ callback: opts.yFmt || (v=>fmtC(v)) }, grid:{color:'rgba(0,0,0,.04)'} },
      },
    },
    plugins: [ChartDataLabels],
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: SUMMARY TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSummary() {
  const recs = getFiltered();
  const { labels, grouped } = getTimeAxis(recs);
  const col = C[STATE.brand];
  const view = document.getElementById('selView').value;
  document.getElementById('summaryTitle').textContent = view === 'week' ? 'Weekly Performance' : 'Period Performance';

  // KPIs â€” aggregate across all filtered records
  const salesA = bSales(recs,'ğŸ”´'), salesB = bSales(recs,'ğŸ”µ');
  const spendA = bSpend(recs,'ğŸ”´'), spendB = bSpend(recs,'ğŸ”µ');
  const cpaA = salesA>0?spendA/salesA:0, cpaB = salesB>0?spendB/salesB:0;
  const spsA = bSPS(recs,'ğŸ”´'), spsB = bSPS(recs,'ğŸ”µ');
  const acqVar = salesB>0?(salesA-salesB)/salesB:null;
  const spVar = spendB>0?(spendA-spendB)/spendB:null;
  const cpaVar = cpaB>0?(cpaA-cpaB)/cpaB:null;

  document.getElementById('summaryKPIs').innerHTML =
    kpi('Sales',fmt(salesA),'ğŸ”µ Budget',fmt(salesB),acqVar,'ğŸ“ˆ',col.act) +
    kpi('Spend',fmtC(spendA),'ğŸ”µ Budget',fmtC(spendB),spVar,'ğŸ’°',col.bud,true) +
    kpi('CPA',fmtCPA(cpaA),'ğŸ”µ Budget',fmtCPA(cpaB),cpaVar,'ğŸ¯',col.fcst,true) +
    kpi('SPS',spsA.toFixed(1),'ğŸ”µ Budget',spsB.toFixed(1),spsB>0?(spsA-spsB)/spsB:null,'âš¡',col.act);

  // Sales by time axis
  makeBarChart('cSalesPeriod', labels, [
    { label:'ğŸ”µ Budget', data:labels.map(t=>bSales(grouped[t]||[],'ğŸ”µ')), backgroundColor:col.bud+'66', borderColor:col.bud, borderWidth:2 },
    { label:'ğŸ”´ Actual', data:labels.map(t=>bSales(grouped[t]||[],'ğŸ”´')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:2 },
    { label:'ğŸŸ¡ Forecast', data:labels.map(t=>bSales(grouped[t]||[],'ğŸŸ¡')), type:'line', borderColor:col.fcst, backgroundColor:'transparent', borderWidth:3, borderDash:[6,3], pointRadius:view==='week'?2:4, pointBackgroundColor:col.fcst, tension:.3, order:-1 },
  ]);

  // CPA by time axis
  makeLineChart('cCPAPeriod', labels, [
    { label:'ğŸ”µ Budget CPA', data:labels.map(t=>bCPA(grouped[t]||[],'ğŸ”µ')), borderColor:col.bud, borderWidth:3, borderDash:[8,4], pointRadius:view==='week'?2:4, pointBackgroundColor:col.bud, tension:.3 },
    { label:'ğŸ”´ Actual CPA', data:labels.map(t=>bCPA(grouped[t]||[],'ğŸ”´')), borderColor:col.act, borderWidth:3, pointRadius:view==='week'?2:5, pointBackgroundColor:col.act, tension:.3 },
  ], { zero:false });

  // Cumulative spend
  let cumB=0, cumA=0;
  const cumBData=[], cumAData=[];
  for(const t of labels) { cumB+=bSpend(grouped[t]||[],'ğŸ”µ'); cumA+=bSpend(grouped[t]||[],'ğŸ”´'); cumBData.push(cumB); cumAData.push(cumA); }
  makeLineChart('cSpendCum', labels, [
    { label:'ğŸ”µ Budget', data:cumBData, borderColor:col.bud, borderWidth:3, borderDash:[8,4], fill:true, backgroundColor:col.bud+'15', tension:.3, pointRadius:view==='week'?0:3 },
    { label:'ğŸ”´ Actual', data:cumAData, borderColor:col.act, borderWidth:3, fill:true, backgroundColor:col.act+'20', tension:.3, pointRadius:view==='week'?0:3 },
  ]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: SALES & CPA TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARED: REGION DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REG_COLOURS = {
  LDN:'#10507C', BRI:'#3A7CA5', EXE:'#6BAED6',
  MCR:'#ED6961', NWC:'#C0392B', SCOT:'#E74C3C',
  DUB:'#27AE60', CRK:'#2ECC71', BF:'#1ABC9C',
};
const REG_GROUP_ORDER = ['SOUTH','NORTH','IE F2F Group'];
const REG_IN_GROUP = {
  SOUTH: ['LDN','BRI','EXE'],
  NORTH: ['MCR','NWC','SCOT'],
  'IE F2F Group': ['DUB','CRK','BF'],
};

function makeStackedChart(id, labels, datasets) {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if(!ctx) return;
  STATE.charts[id] = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{ intersect:false, mode:'index' },
      plugins:{
        legend:{ position:'bottom', labels:{ usePointStyle:true, padding:14, font:{size:11,weight:'600'} } },
        datalabels:{ display:false },
      },
      scales:{
        x:{ stacked:true, grid:{display:false}, ticks:{font:{size:labels.length>20?8:11}} },
        y:{ stacked:true, beginAtZero:true, grid:{color:'rgba(0,0,0,.04)'} },
      },
    },
  });
}

function makeRegionLineChart(id, labels, regions, byTime, metricFn, fmtFn) {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if(!ctx) return;
  const datasets = regions.map(reg => ({
    label: reg,
    data: labels.map(t => {
      const recs = (byTime[t]||[]).filter(r=>gs(r,'âš™ï¸ Region')===reg);
      return metricFn(recs);
    }),
    borderColor: REG_COLOURS[reg]||'#999',
    backgroundColor: 'transparent',
    borderWidth: 2,
    pointRadius: labels.length>20?1:4,
    pointBackgroundColor: REG_COLOURS[reg]||'#999',
    tension: .3,
  }));
  STATE.charts[id] = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{ intersect:false, mode:'index' },
      plugins:{
        legend:{ position:'bottom', labels:{ usePointStyle:true, padding:14, font:{size:11,weight:'600'} } },
        datalabels:{ display:false },
      },
      scales:{
        x:{ grid:{display:false}, ticks:{font:{size:labels.length>20?8:11}} },
        y:{ beginAtZero:false, ticks:{callback:fmtFn}, grid:{color:'rgba(0,0,0,.04)'} },
      },
    },
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: SALES & CPA TAB
// Region group sections with KPI cards, Budget (single) vs
// Actual (stacked by region in red shades), CPA lines, data labels
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Red shades for stacking actual bars within each region group
const RED_SHADES = {
  SOUTH: { LDN:'#C0392B', BRI:'#E74C3C', EXE:'#F1948A' },
  NORTH: { MCR:'#A93226', NWC:'#D4423B', SCOT:'#EC7063' },
  'IE F2F Group': { DUB:'#B03A2E', CRK:'#D5524E', BF:'#F0B5AD' },
};

function getFilteredRegionRecs() {
  let recs = STATE.records.filter(r => gs(r,'âš™ï¸ Level') === 'Region');
  return applyGlobalFilters(recs);
}

function renderSales() {
  const recs = getFilteredRegionRecs();
  const col = C[STATE.brand];
  const view = document.getElementById('selView').value;
  const { labels, grouped: byTime } = getTimeAxis(recs);
  const byRegion = groupBy(recs,'âš™ï¸ Region');

  // Overall KPIs
  const salesA=bSales(recs,'ğŸ”´'), salesB=bSales(recs,'ğŸ”µ'), spendA=bSpend(recs,'ğŸ”´'), spendB=bSpend(recs,'ğŸ”µ');
  const cpaA=salesA>0?spendA/salesA:0, cpaB=salesB>0?spendB/salesB:0;
  document.getElementById('salesKPIs').innerHTML =
    kpi('Sales',fmt(salesA),'ğŸ”µ Budget',fmt(salesB),salesB>0?(salesA-salesB)/salesB:null,'ğŸ“ˆ',col.act) +
    kpi('CPA',fmtCPA(cpaA),'ğŸ”µ Budget',fmtCPA(cpaB),cpaB>0?(cpaA-cpaB)/cpaB:null,'ğŸ¯',col.bud,true) +
    kpi('Spend',fmtC(spendA),'ğŸ”µ Budget',fmtC(spendB),spendB>0?(spendA-spendB)/spendB:null,'ğŸ’°',col.fcst,true);

  // Build HTML for region group sections
  let html = '';
  let chartIdx = 0;
  for (const grp of REG_GROUP_ORDER) {
    const regions = (REG_IN_GROUP[grp]||[]).filter(r => byRegion[r]);
    if (!regions.length) continue;
    const grpRecs = recs.filter(r => regions.includes(gs(r,'âš™ï¸ Region')));
    const gSalesA=bSales(grpRecs,'ğŸ”´'), gSalesB=bSales(grpRecs,'ğŸ”µ'), gSpendA=bSpend(grpRecs,'ğŸ”´'), gSpendB=bSpend(grpRecs,'ğŸ”µ');
    const gCpaA=gSalesA>0?gSpendA/gSalesA:0, gCpaB=gSalesB>0?gSpendB/gSalesB:0;

    html += `<div class="section-hdr"><h2>${grp}</h2><div class="line"></div></div>`;
    // KPI cards per region group
    html += `<div class="kpi-row">`;
    html += kpi('Sales',fmt(gSalesA),'ğŸ”µ Budget',fmt(gSalesB),gSalesB>0?(gSalesA-gSalesB)/gSalesB:null,'ğŸ“ˆ',col.act);
    html += kpi('CPA',fmtCPA(gCpaA),'ğŸ”µ Budget',fmtCPA(gCpaB),gCpaB>0?(gCpaA-gCpaB)/gCpaB:null,'ğŸ¯',col.bud,true);
    // Per-region mini cards
    for (const reg of regions) {
      const rr = byRegion[reg]||[];
      const rs=bSales(rr,'ğŸ”´'), rb=bSales(rr,'ğŸ”µ');
      html += kpi(reg,fmt(rs),'Budget',fmt(rb),rb>0?(rs-rb)/rb:null,'',RED_SHADES[grp]?.[reg]||col.act);
    }
    html += `</div>`;
    // Chart canvases
    const salesId=`cSR_${chartIdx++}`, cpaId=`cSR_${chartIdx++}`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” Sales: Budget vs Actual by Region</h3><div class="chart-wrap"><canvas id="${salesId}"></canvas></div></div></div>`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” CPA by Region</h3><div class="chart-wrap"><canvas id="${cpaId}"></canvas></div></div></div>`;
  }
  document.getElementById('salesRegionCharts').innerHTML = html;

  // Render charts
  chartIdx = 0;
  for (const grp of REG_GROUP_ORDER) {
    const regions = (REG_IN_GROUP[grp]||[]).filter(r => byRegion[r]);
    if (!regions.length) continue;
    const shades = RED_SHADES[grp]||{};

    // SALES: Budget (single blue bar) + Actual stacked by region (red shades)
    const salesId = `cSR_${chartIdx++}`;
    const budgetDS = {
      label:'ğŸ”µ Budget (Total)',
      data: labels.map(t => {
        const tRecs = (byTime[t]||[]).filter(r=>regions.includes(gs(r,'âš™ï¸ Region')));
        return bSales(tRecs,'ğŸ”µ');
      }),
      backgroundColor: col.bud+'88',
      borderColor: col.bud,
      borderWidth: 2,
      stack: 'budget',
    };
    const actualDS = regions.map(reg => ({
      label: `ğŸ”´ ${reg}`,
      data: labels.map(t => {
        const tRecs = (byTime[t]||[]).filter(r=>gs(r,'âš™ï¸ Region')===reg);
        return bSales(tRecs,'ğŸ”´');
      }),
      backgroundColor: (shades[reg]||'#ED6961')+'DD',
      borderColor: shades[reg]||'#ED6961',
      borderWidth: 1,
      stack: 'actual',
    }));
    destroyChart(salesId);
    const ctx1 = document.getElementById(salesId);
    if(ctx1) {
      const showLbl = labels.length <= 13;
      STATE.charts[salesId] = new Chart(ctx1, {
        type:'bar',
        data:{ labels, datasets: [budgetDS, ...actualDS] },
        options:{
responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ top:30 } },
      interaction:{ intersect:false, mode:'index' },
      plugins:{
        legend:{ position:'bottom', labels:{ usePointStyle:true, padding:14, font:{size:11,weight:'600'} } },
        datalabels:{ display:showLbl, anchor:'end', align:'top', font:{size:12,weight:'700'},
              color:function(c){return c.dataset.borderColor||'#555'},
              formatter:v=>v>0?fmt(v):'',
            },
          },
          scales:{
            x:{ stacked:true, grid:{display:false}, ticks:{font:{size:labels.length>20?8:11}} },
            y:{ stacked:true, beginAtZero:true, grid:{color:'rgba(0,0,0,.04)'} },
          },
        },
        plugins:[ChartDataLabels],
      });
    }

    // CPA: line per region with data labels
    const cpaId = `cSR_${chartIdx++}`;
    destroyChart(cpaId);
    const ctx2 = document.getElementById(cpaId);
    if(ctx2) {
      const showLbl = labels.length <= 13;
      const cpaDS = regions.map(reg => ({
        label: reg,
        data: labels.map(t => {
          const tRecs = (byTime[t]||[]).filter(r=>gs(r,'âš™ï¸ Region')===reg);
          return bCPA(tRecs,'ğŸ”´');
        }),
        borderColor: shades[reg]||REG_COLOURS[reg]||'#999',
        backgroundColor: 'transparent',
        borderWidth: 2.5,
        pointRadius: labels.length>20?2:5,
        pointBackgroundColor: shades[reg]||REG_COLOURS[reg]||'#999',
        tension: .3,
      }));
      // Budget CPA line (dashed blue)
      const budCPA = {
        label: 'ğŸ”µ Budget CPA',
        data: labels.map(t => {
          const tRecs = (byTime[t]||[]).filter(r=>regions.includes(gs(r,'âš™ï¸ Region')));
          return bCPA(tRecs,'ğŸ”µ');
        }),
        borderColor: col.bud,
        backgroundColor: 'transparent',
        borderWidth: 3,
        borderDash: [8,4],
        pointRadius: labels.length>20?1:4,
        pointBackgroundColor: col.bud,
        tension: .3,
      };
      STATE.charts[cpaId] = new Chart(ctx2, {
        type:'line',
        data:{ labels, datasets: [budCPA, ...cpaDS] },
        options:{
responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ top:30 } },
      interaction:{ intersect:false, mode:'index' },
      plugins:{
        legend:{ position:'bottom', labels:{ usePointStyle:true, padding:14, font:{size:11,weight:'600'} } },
        datalabels:{ display:showLbl, anchor:'end', align:'top', font:{size:11,weight:'700'},
              color:function(c){return c.dataset.borderColor||'#555'},
              formatter:v=>v>0?fmtCPA(v):'',
            },
          },
          scales:{
            x:{ grid:{display:false}, ticks:{font:{size:labels.length>20?8:11}} },
            y:{ beginAtZero:false, ticks:{callback:v=>fmtCPA(v)}, grid:{color:'rgba(0,0,0,.04)'} },
          },
        },
        plugins:[ChartDataLabels],
      });
    }
  }

  // Period detail table
  let h=`<thead><tr><th>${view==='week'?'Week':'Period'}</th><th>ğŸ”µğŸ¶ Sales</th><th>ğŸ”´ğŸ¶ Actual</th><th>ğŸ¶ Var%</th><th>ğŸ”µğŸ± Sales</th><th>ğŸ”´ğŸ± Actual</th><th>ğŸ± Var%</th><th>ğŸ”´ğŸ¶ CPA</th><th>ğŸ”´ğŸ± CPA</th></tr></thead><tbody>`;
  for(const t of labels) {
    const r=byTime[t]||[];
    const bs=sum(r,'ğŸ”µğŸ¶ Sales'),ba2=sum(r,'ğŸ”´ğŸ¶ Sales'),ms2=sum(r,'ğŸ”µğŸ± Sales'),ma2=sum(r,'ğŸ”´ğŸ± Sales');
    const bv=bs>0?(ba2-bs)/bs:0, mv=ms2>0?(ma2-ms2)/ms2:0;
    const bc2=sum(r,'ğŸ”´ğŸ¶ Spend'),mc2=sum(r,'ğŸ”´ğŸ± Spend');
    h+=`<tr><td>${t}</td><td>${fmt(bs)}</td><td>${fmt(ba2)}</td><td class="${bv>=0?'pos':'neg'}">${fmtV(bv)}</td><td>${fmt(ms2)}</td><td>${fmt(ma2)}</td><td class="${mv>=0?'pos':'neg'}">${fmtV(mv)}</td><td>${fmtCPA(ba2>0?bc2/ba2:0)}</td><td>${fmtCPA(ma2>0?mc2/ma2:0)}</td></tr>`;
  }
  h+='</tbody>';
  document.getElementById('tblPeriod').innerHTML = h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: REGIONAL TAB (summary totals, controlled by filters)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRegions() {
  const recs = getFilteredRegionRecs();
  const col = C[STATE.brand];

  const byRegion = groupBy(recs,'âš™ï¸ Region');

  // Region cards â€” UK left, IE right
  const allRegions = [...(REG_IN_GROUP.SOUTH||[]), ...(REG_IN_GROUP.NORTH||[]), ...(REG_IN_GROUP['IE F2F Group']||[])];
  const activeRegions = allRegions.filter(r => byRegion[r]);

  let cards = '';
  for(const reg of activeRegions) {
    const r = byRegion[reg]||[];
    const sales = bSales(r,'ğŸ”´'), salesB = bSales(r,'ğŸ”µ');
    const cpa = bCPA(r,'ğŸ”´'), sps = bSPS(r,'ğŸ”´');
    const team = sum(r,'ğŸ”´ BA Team Size') + sum(r,'ğŸ”´ Rep Team Size');
    const salesVar = salesB>0?(sales-salesB)/salesB:null;
    cards += `<div class="region-card" style="border-left-color:${REG_COLOURS[reg]||col.bud}">
      <div class="rname">${reg}</div>
      <div class="rval">${fmt(sales)}</div>
      ${salesVar!=null?`<div class="rsub" style="font-weight:700;color:${salesVar>=0?'var(--pos)':'var(--neg)'}">${fmtV(salesVar)} vs budget</div>`:''}
      <div class="rsub">CPA: ${fmtCPA(cpa)} | SPS: ${sps.toFixed(1)}</div>
      <div class="rsub">Team: ${fmt(team)} (BA ${sum(r,'ğŸ”´ BA Team Size')} + Rep ${sum(r,'ğŸ”´ Rep Team Size')})</div>
    </div>`;
  }
  document.getElementById('regionCards').innerHTML = cards;

  // Summary bar charts â€” totals per region
  makeBarChart('cRegSumSales', activeRegions, [
    { label:'ğŸ”µ Budget', data:activeRegions.map(r=>bSales(byRegion[r]||[],'ğŸ”µ')), backgroundColor:col.bud+'66', borderColor:col.bud, borderWidth:1 },
    { label:'ğŸ”´ Actual', data:activeRegions.map(r=>bSales(byRegion[r]||[],'ğŸ”´')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:1 },
  ]);

  makeBarChart('cRegSumCPA', activeRegions, [
    { label:'ğŸ”µ Budget CPA', data:activeRegions.map(r=>bCPA(byRegion[r]||[],'ğŸ”µ')), backgroundColor:col.bud+'66', borderColor:col.bud, borderWidth:1 },
    { label:'ğŸ”´ Actual CPA', data:activeRegions.map(r=>bCPA(byRegion[r]||[],'ğŸ”´')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:1 },
  ], { yFmt: v=>fmtCPA(v) });

  makeBarChart('cRegSumSPS', activeRegions, [
    { label:'ğŸ”µ Budget SPS', data:activeRegions.map(r=>bSPS(byRegion[r]||[],'ğŸ”µ')), backgroundColor:col.bud+'66', borderColor:col.bud, borderWidth:1 },
    { label:'ğŸ”´ Actual SPS', data:activeRegions.map(r=>bSPS(byRegion[r]||[],'ğŸ”´')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:1 },
  ], { yFmt: v=>v.toFixed(1) });

  // Team stacked BA/Rep
  makeStackedChart('cRegSumTeam', activeRegions, [
    { label:'BA', data:activeRegions.map(r=>sum(byRegion[r]||[],'ğŸ”´ BA Team Size')), backgroundColor:'#10507CAA', borderColor:'#10507C', borderWidth:1 },
    { label:'Rep', data:activeRegions.map(r=>sum(byRegion[r]||[],'ğŸ”´ Rep Team Size')), backgroundColor:'#ED6961AA', borderColor:'#ED6961', borderWidth:1 },
  ]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: TEAM TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Team colour shades per region group (blue shades for team)
const TEAM_SHADES = {
  SOUTH: { LDN:'#1A5276', BRI:'#2980B9', EXE:'#5DADE2' },
  NORTH: { MCR:'#7B241C', NWC:'#C0392B', SCOT:'#E74C3C' },
  'IE F2F Group': { DUB:'#1E8449', CRK:'#27AE60', BF:'#58D68D' },
};

function renderTeam() {
  const recs = getFilteredRegionRecs();
  const col = C[STATE.brand];
  const view = document.getElementById('selView').value;
  const { labels, grouped: byTime } = getTimeAxis(recs);
  const byRegion = groupBy(recs,'âš™ï¸ Region');

  // Overall KPIs
  const totalActual = sum(recs,'ğŸ”´ Total Team Size'), totalRequired = sum(recs,'ğŸŸ¡ Team Size Required');
  const totalBA = sum(recs,'ğŸ”´ BA Team Size'), totalRep = sum(recs,'ğŸ”´ Rep Team Size');
  const budgetRep = sum(recs,'ğŸ”µ Rep Team Size p/w');
  const avgStaff = avg(recs,'ğŸ”´ Staffing Performance');
  const teamVar = totalRequired>0?(totalActual-totalRequired)/totalRequired:null;

  document.getElementById('teamKPIs').innerHTML =
    kpi('Actual Team',fmt(totalActual),'ğŸŸ¡ Required',fmt(totalRequired),teamVar,'ğŸ‘¥',col.act) +
    kpi('BA Team',fmt(totalBA),'Brand Ambassadors','',null,'ğŸª',col.bud) +
    kpi('Rep Team',fmt(totalRep),'ğŸ”µ Budget Reps',fmt(budgetRep),budgetRep>0?(totalRep-budgetRep)/budgetRep:null,'ğŸ·ï¸',col.fcst) +
    kpi('Staffing %',fmtP(avgStaff),'Actual / Forecast','',avgStaff>0?avgStaff-1:null,'âš¡',avgStaff>=0.95?'var(--pos)':'var(--neg)');

  // Build per-region-group sections (same structure as Sales & CPA)
  let html = '';
  let chartIdx = 0;

  for (const grp of REG_GROUP_ORDER) {
    const regions = (REG_IN_GROUP[grp]||[]).filter(r => byRegion[r]);
    if (!regions.length) continue;
    const grpRecs = recs.filter(r => regions.includes(gs(r,'âš™ï¸ Region')));
    const gActual = sum(grpRecs,'ğŸ”´ Total Team Size'), gRequired = sum(grpRecs,'ğŸŸ¡ Team Size Required');
    const gBA = sum(grpRecs,'ğŸ”´ BA Team Size'), gRep = sum(grpRecs,'ğŸ”´ Rep Team Size');
    const gBudgetRep = sum(grpRecs,'ğŸ”µ Rep Team Size p/w');
    const shades = TEAM_SHADES[grp]||{};

    // Section header
    html += `<div class="section-hdr"><h2>${grp}</h2><div class="line"></div></div>`;

    // KPI cards
    html += `<div class="kpi-row">`;
    html += kpi('Actual Team',fmt(gActual),'ğŸŸ¡ Required',fmt(gRequired),gRequired>0?(gActual-gRequired)/gRequired:null,'ğŸ‘¥',col.act);
    html += kpi('BA',fmt(gBA),'Rep',fmt(gRep),null,'ğŸª',col.bud);
    html += kpi('Budget Reps',fmt(gBudgetRep),'Actual Reps',fmt(gRep),gBudgetRep>0?(gRep-gBudgetRep)/gBudgetRep:null,'ğŸ·ï¸',col.fcst);
    // Per-region mini cards
    for (const reg of regions) {
      const rr = byRegion[reg]||[];
      const rt = sum(rr,'ğŸ”´ Total Team Size'), rq = sum(rr,'ğŸŸ¡ Team Size Required');
      html += kpi(reg,fmt(rt),'Required',fmt(rq),rq>0?(rt-rq)/rq:null,'',shades[reg]||col.act);
    }
    html += `</div>`;

    // Chart 1: Budget Team Size vs Team Size Required vs Total Team Size
    const c1 = `cTM_${chartIdx++}`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” Budget vs Required vs Actual Team Size</h3><div class="chart-wrap"><canvas id="${c1}"></canvas></div></div></div>`;

    // Chart 2: BA Team Size vs Rep Team Size vs Team Size Required
    const c2 = `cTM_${chartIdx++}`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” BA vs Rep vs Required</h3><div class="chart-wrap"><canvas id="${c2}"></canvas></div></div></div>`;

    // Chart 3: Rep Shifts Required vs Forecast Shifts
    const c3 = `cTM_${chartIdx++}`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” Rep Shifts Required vs Forecast Shifts</h3><div class="chart-wrap"><canvas id="${c3}"></canvas></div></div></div>`;

    // Chart 4: SPS Trend
    const c4 = `cTM_${chartIdx++}`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” SPS Trend</h3><div class="chart-wrap"><canvas id="${c4}"></canvas></div></div></div>`;
  }
  document.getElementById('teamRegionCharts').innerHTML = html;

  // Render charts
  chartIdx = 0;
  for (const grp of REG_GROUP_ORDER) {
    const regions = (REG_IN_GROUP[grp]||[]).filter(r => byRegion[r]);
    if (!regions.length) continue;
    const grpRecs = recs.filter(r => regions.includes(gs(r,'âš™ï¸ Region')));
    const grpByTime = groupBy(grpRecs, document.getElementById('selView').value==='week'?'âš™ï¸ Week':'âš™ï¸ Period');
    const shades = TEAM_SHADES[grp]||{};
    const showLbl = labels.length <= 13;

    // Chart 1: Budget vs Required vs Actual (3 grouped bars)
    const c1 = `cTM_${chartIdx++}`;
    destroyChart(c1);
    const ctx1 = document.getElementById(c1);
    if(ctx1) {
      STATE.charts[c1] = new Chart(ctx1, {
        type:'bar',
        data:{ labels, datasets:[
          { label:'ğŸ”µ Budget Team', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸ”µ Rep Team Size p/w')), backgroundColor:col.bud+'88', borderColor:col.bud, borderWidth:2 },
          { label:'ğŸŸ¡ Required', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸŸ¡ Team Size Required')), backgroundColor:col.fcst+'88', borderColor:col.fcst, borderWidth:2 },
          { label:'ğŸ”´ Actual Team', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸ”´ Total Team Size')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:2 },
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          layout:{ padding:{ top:30 } },
          plugins:{ legend:{ position:'bottom', labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}} },
            datalabels:{ display:showLbl, anchor:'end', align:'top', font:{size:11,weight:'700'}, color:function(c){return c.dataset.borderColor||'#555'}, formatter:v=>v>0?fmt(v):'' },
          },
          scales:{ x:{grid:{display:false},ticks:{font:{size:labels.length>20?8:11}}}, y:{beginAtZero:true,grid:{color:'rgba(0,0,0,.04)'}} },
        },
        plugins:[ChartDataLabels],
      });
    }

    // Chart 2: BA + Rep stacked next to Required
    const c2 = `cTM_${chartIdx++}`;
    destroyChart(c2);
    const ctx2 = document.getElementById(c2);
    if(ctx2) {
      STATE.charts[c2] = new Chart(ctx2, {
        type:'bar',
        data:{ labels, datasets:[
          { label:'ğŸ”´ Rep', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸ”´ Rep Team Size')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:1, stack:'actual' },
          { label:'ğŸ”´ BA', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸ”´ BA Team Size')), backgroundColor:'#1A5276CC', borderColor:'#1A5276', borderWidth:1, stack:'actual' },
          { label:'ğŸŸ¡ Required', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸŸ¡ Team Size Required')), backgroundColor:col.fcst+'88', borderColor:col.fcst, borderWidth:2, stack:'required' },
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          layout:{ padding:{ top:30 } },
          plugins:{ legend:{ position:'bottom', labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}} },
            datalabels:{ display:showLbl, anchor:'end', align:'top', font:{size:11,weight:'700'}, color:function(c){return c.dataset.borderColor||'#555'}, formatter:v=>v>0?fmt(v):'' },
          },
          scales:{ x:{stacked:true,grid:{display:false},ticks:{font:{size:labels.length>20?8:11}}}, y:{stacked:true,beginAtZero:true,grid:{color:'rgba(0,0,0,.04)'}} },
        },
        plugins:[ChartDataLabels],
      });
    }

    // Chart 3: Rep Shifts Required vs Forecast Shifts
    const c3 = `cTM_${chartIdx++}`;
    makeBarChart(c3, labels, [
      { label:'ğŸ”´ Rep Shifts Required', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸ”´ Rep Shifts Required')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:2 },
      { label:'ğŸŸ¡ Forecast Shifts', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸŸ¡ Shifts')), backgroundColor:col.fcst+'88', borderColor:col.fcst, borderWidth:2 },
    ]);

    // Chart 4: SPS trend (lines per region)
    const c4 = `cTM_${chartIdx++}`;
    makeRegionLineChart(c4, labels, regions, grpByTime, r=>bSPS(r,'ğŸ”´'), v=>v?v.toFixed(1):'');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  renderSummary();
  renderSales();
  renderRegions();
  renderTeam();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTab(id, btn) {
  document.querySelectorAll('.tab-page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  if(btn) btn.classList.add('active');
}

function setBrand(b) {
  STATE.brand = b;
  document.body.className = b==='marro'?'theme-marro':b==='combined'?'theme-combined':'';
  document.querySelectorAll('.brand-btn').forEach(btn=>btn.classList.remove('active'));
  event.target.classList.add('active');
  const titles = { butternut:'ğŸ¶ DS Performance Dashboard', marro:'ğŸ± DS Performance Dashboard', combined:'ğŸ¾ DS Performance Dashboard' };
  document.getElementById('title').textContent = titles[b];
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POPULATE FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateFilters(records) {
  // Periods
  const periods = new Set(records.map(r=>gs(r,'âš™ï¸ Period')).filter(Boolean));
  const selP = document.getElementById('selPeriod');
  selP.innerHTML = '<option value="all">All Periods</option>';
  PERIODS.filter(p=>periods.has(p)).forEach(p => { const o=document.createElement('option'); o.value=p; o.textContent=p; selP.appendChild(o); });

  // Weeks
  const weeks = new Set(records.map(r=>gs(r,'âš™ï¸ Week')).filter(Boolean));
  const selW = document.getElementById('selWeek');
  selW.innerHTML = '<option value="all">All Weeks</option>';
  WEEKS.filter(w=>weeks.has(w)).forEach(w => { const o=document.createElement('option'); o.value=w; o.textContent=w; selW.appendChild(o); });

  // Region Groups
  const selRG = document.getElementById('selRegionGroup');
  selRG.innerHTML = '<option value="all">All Region Groups</option>';
  REG_GROUP_ORDER.forEach(rg => { const o=document.createElement('option'); o.value=rg; o.textContent=rg; selRG.appendChild(o); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadData() {
  // Check URL param first, then localStorage, then show config
  const urlToken = new URLSearchParams(window.location.search).get('token');
  const token = urlToken || localStorage.getItem('at_token');
  if (urlToken) localStorage.setItem('at_token', urlToken); // save for next visit
  if (!token) { document.getElementById('configPanel').style.display='block'; return; }

  document.getElementById('configPanel').style.display='none';
  document.getElementById('loadingEl').style.display='flex';

  try {
    const year = '2026';
    STATE.records = await fetchRecords(token, year);
    console.log(`âœ… Loaded ${STATE.records.length} records for ${year}`);
    populateFilters(STATE.records);
    document.getElementById('loadingEl').style.display='none';
    render();
  } catch(e) {
    console.error(e);
    document.getElementById('loadingEl').innerHTML = `<div style="color:var(--neg);text-align:center"><h3>Error Loading Data</h3><p style="margin-top:8px">${e.message}</p><button onclick="localStorage.removeItem('at_token');location.reload()" style="margin-top:12px;padding:8px 16px;border-radius:6px;border:none;background:var(--hdr);color:var(--hdr-t);cursor:pointer;font-weight:600">Reconfigure</button></div>`;
  }
}

function saveConfig() {
  const token = document.getElementById('cfgToken').value.trim();
  if (!token) return;
  localStorage.setItem('at_token', token);
  loadData();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  loadData();
});
</script>
</body>
</html>

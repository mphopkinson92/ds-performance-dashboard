<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DS Performance Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS VARIABLES & BASE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#FFF6D8;--card:#fff;--text:#522A10;--text2:#888;--border:rgba(82,42,16,.1);
  --hdr:#522A10;--hdr-t:#FFE180;
  --bud:#10507C;--fcst:#522A10;--act:#ED6961;
  --pos:#4CAF50;--neg:#ED6961;
}
.theme-marro {
  --bg:#FDF5F5;--text:#2D2D2D;--border:rgba(128,2,15,.08);
  --hdr:#80020F;--hdr-t:#fff;
  --bud:#80020F;--fcst:#DABFBD;--act:#C88131;
}
.theme-combined {
  --bg:#F9F6F0;--text:#2D2D2D;--border:rgba(0,0,0,.06);
  --hdr:#3A3A3A;--hdr-t:#fff;
  --bud:#10507C;--fcst:#9BC3FE;--act:#522A10;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background .3s}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOP BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.top{background:var(--hdr);color:var(--hdr-t);padding:10px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.15)}
.top h1{font-size:15px;font-weight:700}
.top-ctrls{display:flex;align-items:center;gap:10px}
.top-ctrls select,.top-ctrls button{padding:5px 10px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.1);color:var(--hdr-t)}
.top-ctrls select option{color:#333;background:#fff}
.brand-btn{border:none!important;opacity:.65;transition:all .2s}
.brand-btn.active{opacity:1;background:rgba(255,255,255,.25)!important}
.refresh-btn{background:rgba(255,255,255,.2)!important;border:none!important}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs{display:flex;background:var(--card);border-bottom:2px solid var(--border);overflow-x:auto}
.tab-btn{padding:11px 22px;border:none;background:0;cursor:pointer;font-size:13px;font-weight:600;color:var(--text2);border-bottom:3px solid transparent;white-space:nowrap;transition:all .2s}
.tab-btn:hover{color:var(--text)}
.tab-btn.active{color:var(--bud);border-bottom-color:var(--bud)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTENT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.content{max-width:1440px;margin:0 auto;padding:20px 24px 60px}
.tab-page{display:none}.tab-page.active{display:block}
.section-hdr{display:flex;align-items:center;gap:10px;margin:20px 0 12px}
.section-hdr h2{font-size:15px;font-weight:700}
.section-hdr .line{flex:1;height:2px;background:var(--border)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KPI CARDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.kpi-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
.kpi{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 2px 10px var(--border);flex:1 1 200px;min-width:180px;position:relative;overflow:hidden;transition:transform .2s}
.kpi:hover{transform:translateY(-2px)}
.kpi .stripe{position:absolute;top:0;left:0;right:0;height:4px}
.kpi .icon{position:absolute;top:12px;right:14px;font-size:18px;opacity:.35}
.kpi .label{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text2);font-weight:600;margin-bottom:4px}
.kpi .value{font-size:24px;font-weight:800;color:var(--text)}
.kpi .compare{font-size:11px;color:var(--text2);margin-top:4px}
.kpi .compare b{font-weight:600}
.kpi .var{font-size:12px;font-weight:700;margin-top:3px}
.kpi .var.pos{color:var(--pos)}.kpi .var.neg{color:var(--neg)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chart-row{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}
.chart-card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 2px 10px var(--border);flex:1 1 48%;min-width:320px}
.chart-card.full{flex:1 1 100%}
.chart-card h3{font-size:13px;font-weight:700;margin-bottom:10px}
.chart-wrap{position:relative;height:340px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tbl-wrap{background:var(--card);border-radius:10px;box-shadow:0 2px 10px var(--border);overflow:hidden;margin-bottom:16px}
.tbl-wrap h3{padding:14px 16px 8px;font-size:13px;font-weight:700}
.tbl-wrap .scroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{background:var(--hdr);color:var(--hdr-t);padding:8px 12px;font-weight:600;white-space:nowrap;text-align:right;position:sticky;top:0}
thead th:first-child{text-align:left}
tbody td{padding:7px 12px;text-align:right;border-bottom:1px solid var(--border)}
tbody td:first-child{text-align:left;font-weight:600}
tbody tr:hover{background:rgba(0,0,0,.02)}
.pos{color:var(--pos);font-weight:600}.neg{color:var(--neg);font-weight:600}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BRAND PANELS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.brand-split{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px}
.brand-col{flex:1 1 48%;min-width:300px;border-radius:10px;overflow:hidden;box-shadow:0 2px 10px var(--border)}
.brand-col-hdr{padding:10px 16px;font-weight:700;font-size:14px}
.brand-col-hdr.bbn{background:#FFD54D;color:#522A10}
.brand-col-hdr.mro{background:#80020F;color:#fff}
.brand-col-body{background:var(--card);padding:14px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REGION CARDS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.region-grid{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
.region-card{background:var(--card);border-radius:10px;padding:14px 18px;text-align:center;box-shadow:0 2px 8px var(--border);min-width:130px;flex:1 1 auto;border-left:4px solid var(--bud)}
.region-card .rname{font-size:11px;font-weight:700;text-transform:uppercase;color:var(--text2);letter-spacing:.5px}
.region-card .rval{font-size:22px;font-weight:800;margin-top:3px}
.region-card .rsub{font-size:10px;color:var(--text2);margin-top:2px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG PANEL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.config{background:var(--card);border-radius:12px;padding:30px;max-width:500px;margin:40px auto;box-shadow:0 4px 24px var(--border)}
.config h2{margin-bottom:16px;font-size:18px}
.config label{display:block;font-size:13px;font-weight:600;color:var(--text2);margin-bottom:4px}
.config input{width:100%;padding:10px 14px;border:2px solid var(--border);border-radius:8px;font-size:14px;margin-bottom:14px}
.config input:focus{outline:none;border-color:var(--bud)}
.config button{width:100%;padding:12px;border:none;border-radius:8px;background:var(--hdr);color:var(--hdr-t);font-weight:700;font-size:15px;cursor:pointer}
.config .hint{font-size:11px;color:var(--text2);margin-top:-10px;margin-bottom:14px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING & RESPONSIVE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.loading{display:flex;align-items:center;justify-content:center;min-height:300px;flex-direction:column;gap:12px}
.spinner{width:36px;height:36px;border:4px solid var(--border);border-top-color:var(--bud);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:900px){.chart-row,.brand-split{flex-direction:column}.kpi-row{flex-wrap:wrap}}
@media(max-width:600px){.kpi{min-width:100%}.tab-btn{padding:9px 14px;font-size:12px}.content{padding:12px}}
@media print{.top,.tabs{position:relative}body{-webkit-print-color-adjust:exact;print-color-adjust:exact}}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOP BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="top">
  <h1 id="title">ğŸ¾ DS Performance Dashboard</h1>
  <div class="top-ctrls">
    <button class="brand-btn active" onclick="setBrand('butternut')">ğŸ¶ BBN</button>
    <button class="brand-btn" onclick="setBrand('marro')">ğŸ± MRO</button>
    <button class="brand-btn" onclick="setBrand('combined')">ğŸ¾ All</button>
    <select id="selView" onchange="onViewChange()" title="View by">
      <option value="week" selected>By Week</option>
      <option value="period">By Period</option>
    </select>
    <select id="selRange" onchange="render()" title="Quarter">
      <option value="ytd">YTD</option>
      <option value="Q1">Q1 (P1-P3)</option>
      <option value="Q2">Q2 (P4-P6)</option>
      <option value="Q3">Q3 (P7-P9)</option>
      <option value="Q4">Q4 (P10-P13)</option>
      <option value="full">Full Year</option>
    </select>
    <select id="selPeriod" onchange="render()"><option value="all">All Periods</option></select>
    <select id="selWeek" onchange="render()"><option value="all">All Weeks</option></select>
    <select id="selRegionGroup" onchange="render()"><option value="all">All Region Groups</option></select>
    <select id="selRegion" onchange="render()"><option value="all">All Regions</option></select>
    <select id="selChannel" onchange="render()">
      <option value="Face to Face" selected>Face to Face</option>
      <option value="Telesales">Telesales</option>
      <option value="all">All Channels</option>
    </select>
    <button class="refresh-btn" onclick="loadData()" title="Refresh data">â†»</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TABS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tabs">
  <button class="tab-btn active" onclick="setTab('summary',this)">ğŸ“Š Summary</button>
  <button class="tab-btn" onclick="setTab('sales',this)">ğŸ“ˆ Sales & CPA</button>
  <button class="tab-btn" onclick="setTab('regions',this)">ğŸ—ºï¸ Regional</button>
  <button class="tab-btn" onclick="setTab('retention',this)">ğŸ“¦ Retention</button>
  <button class="tab-btn" onclick="setTab('team',this)">ğŸ‘¥ Team & Staffing</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="content">
  <!-- Config -->
  <div id="configPanel" class="config" style="display:none">
    <h2>Connect to Airtable</h2>
    <label>Personal Access Token</label>
    <input type="password" id="cfgToken" placeholder="pat...">
    <p class="hint">Create at airtable.com/create/tokens â€” needs data.records:read scope on the Budget Tracking base.</p>
    <button onclick="saveConfig()">Connect & Load Data</button>
  </div>

  <!-- Loading -->
  <div id="loadingEl" class="loading" style="display:none"><div class="spinner"></div><span style="color:var(--text2)">Loading data from Airtable...</span></div>

  <!-- TAB: SUMMARY -->
  <div id="tab-summary" class="tab-page active">
    <div id="mktSummary_summary"></div>
    <div class="section-hdr"><h2 id="summaryTitle">YTD Performance</h2><div class="line"></div></div>
    <div class="kpi-row" id="summaryKPIs"></div>
    <div class="chart-row">
      <div class="chart-card full"><h3>Sales: Budget vs Actual vs Forecast</h3><div class="chart-wrap"><canvas id="cSalesPeriod"></canvas></div></div>
    </div>
    <div class="chart-row">
      <div class="chart-card full"><h3>CPA: Budget vs Actual</h3><div class="chart-wrap"><canvas id="cCPAPeriod"></canvas></div></div>
    </div>
    <div class="chart-row">
      <div class="chart-card full"><h3>Cumulative Spend: Budget vs Actual</h3><div class="chart-wrap"><canvas id="cSpendCum"></canvas></div></div>
    </div>
  </div>

  <!-- TAB: SALES & CPA (by Region Group, stacked by region, weekly) -->
  <div id="tab-sales" class="tab-page">
    <div id="mktSummary_sales"></div>
    <div class="section-hdr"><h2>Sales & CPA by Region Group</h2><div class="line"></div></div>
    <div class="kpi-row" id="salesKPIs"></div>
    <div id="salesRegionCharts"></div>
    <div class="tbl-wrap"><h3>Period Detail</h3><div class="scroll"><table id="tblPeriod"></table></div></div>
  </div>

  <!-- TAB: REGIONAL (per region group, Budget vs Forecast vs Actual) -->
  <div id="tab-regions" class="tab-page">
    <div id="mktSummary_regions"></div>
    <div class="section-hdr"><h2>Regional Summary</h2><div class="line"></div></div>
    <div class="kpi-row" id="regionOverallKPIs"></div>
    <div id="regionGroupSections"></div>
  </div>

  <!-- TAB: RETENTION -->
  <div id="tab-retention" class="tab-page">
    <div id="mktSummary_retention"></div>
    <div class="section-hdr"><h2>Retention, Discounts & Engagement</h2><div class="line"></div></div>
    <div class="kpi-row" id="retentionKPIs"></div>
    <div id="retentionCharts"></div>
  </div>

  <!-- TAB: TEAM -->
  <div id="tab-team" class="tab-page">
    <div id="mktSummary_team"></div>
    <div class="section-hdr"><h2>Team Size & Staffing</h2><div class="line"></div></div>
    <div class="kpi-row" id="teamKPIs"></div>
    <div id="teamRegionCharts"></div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BASE_ID = 'appcbUbKvlLayiuo5';
const TABLE_NAME = 'ğŸ“Š Weekly Summary';
const PERIODS = ['P1','P2','P3','P4','P5','P6','P7','P8','P9','P10','P11','P12','P13'];
const P_ORD = Object.fromEntries(PERIODS.map((p,i)=>[p,i+1]));
const WEEKS = Array.from({length:52},(_,i)=>`W${i+1}`);
const W_ORD = Object.fromEntries(WEEKS.map((w,i)=>[w,i+1]));

// Brand colour palettes
const C = {
  butternut: { bud:'#10507C', fcst:'#FFD54D', act:'#ED6961', budA:.4, actA:.8 },
  marro:     { bud:'#10507C', fcst:'#FFD54D', act:'#ED6961', budA:.4, actA:.8 },
  combined:  { bud:'#10507C', fcst:'#FFD54D', act:'#ED6961', budA:.4, actA:.8 },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let STATE = { brand:'butternut', records:[], charts:{} };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AIRTABLE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchRecords(token, year) {
  const fields = [
    'âš™ï¸ Year','âš™ï¸ Period','âš™ï¸ Week','âš™ï¸ Region','âš™ï¸ Region Group','âš™ï¸ Market','âš™ï¸ Channel','âš™ï¸ Level',
    'ğŸ”µğŸ¶ Sales','ğŸŸ¡ğŸ¶ Sales','ğŸ”´ğŸ¶ Sales','ğŸ”µğŸ± Sales','ğŸŸ¡ğŸ± Sales','ğŸ”´ğŸ± Sales',
    'ğŸ”µğŸ¶ Spend','ğŸŸ¡ğŸ¶ Spend','ğŸ”´ğŸ¶ Spend','ğŸ”µğŸ± Spend','ğŸŸ¡ğŸ± Spend','ğŸ”´ğŸ± Spend',
    'ğŸ”µğŸ¶ CPA','ğŸŸ¡ğŸ¶ CPA','ğŸ”´ğŸ¶ CPA','ğŸ”µğŸ± CPA','ğŸŸ¡ğŸ± CPA','ğŸ”´ğŸ± CPA',
    'ğŸ”µğŸ¶ SPS','ğŸŸ¡ğŸ¶ SPS','ğŸ”´ğŸ¶ SPS','ğŸ”µğŸ± SPS','ğŸŸ¡ğŸ± SPS','ğŸ”´ğŸ± SPS',
    'ğŸ”´ Rep Team Size','ğŸ”´ BA Team Size','ğŸ”´ Total Team Size','ğŸŸ¡ Team Size Required','ğŸ”µ Rep Team Size p/w',
    'ğŸ”´ Shifts','ğŸŸ¡ Shifts','ğŸ”´ Shift Capacity','ğŸ”´ Staffing Performance','ğŸ”´ Rep Shifts Required',
    'ğŸ¶ Sales Var vs Budget','ğŸ¶ Sales Var % vs Budget','ğŸ± Sales Var vs Budget','ğŸ± Sales Var % vs Budget',
    'ğŸ¶ Spend Var vs Budget','ğŸ± Spend Var vs Budget',
    'ğŸ”´ğŸ¶ Box 2 Retention','ğŸ”´ğŸ± Box 2 Retention','ğŸ”´ğŸ¶ Box 3 Retention','ğŸ”´ğŸ± Box 3 Retention',
    'ğŸ”´ğŸ¶ Box 1 Count','ğŸ”´ğŸ± Box 1 Count',
    'ğŸ”´ğŸ¶ Box 1 Average Discount','ğŸ”´ğŸ± Box 1 Average Discount',
    'ğŸ”´ App Download %','ğŸ”´ Tail Mail %','âœ… 28 day retention week Tick',
  ];
  const headers = { Authorization: `Bearer ${token}` };
  let all = [], offset = null;
  do {
    let url = `https://api.airtable.com/v0/${BASE_ID}/${encodeURIComponent(TABLE_NAME)}?`;
    url += fields.map(f=>`fields[]=${encodeURIComponent(f)}`).join('&');
    url += `&filterByFormula=${encodeURIComponent(`{âš™ï¸ Year}="${year}"`)}`;
    if (offset) url += `&offset=${offset}`;
    const resp = await fetch(url, { headers });
    if (!resp.ok) throw new Error(`API ${resp.status}: ${resp.statusText}`);
    const json = await resp.json();
    all = all.concat(json.records);
    offset = json.offset;
  } while (offset);
  return all;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gv(r,f){ const v=r.fields[f]; if(v==null) return 0; if(typeof v==='object'&&v.name) return v.name; if(typeof v==='string') return parseFloat(v.replace(/[Â£,]/g,''))||0; return Number(v)||0; }
function gs(r,f){ const v=r.fields[f]; if(!v) return ''; if(typeof v==='object'&&v.name) return v.name; return String(v); }
function sum(recs,f){ return recs.reduce((s,r)=>s+gv(r,f),0); }
function avg(recs,f){ const vals=recs.map(r=>gv(r,f)).filter(v=>v!==0&&v!==null&&!isNaN(v)); return vals.length?vals.reduce((a,b)=>a+b,0)/vals.length:0; }
function wAvg(recs,numF,denF){ const n=sum(recs,numF),d=sum(recs,denF); return d?n/d:0; }

function fmt(n){ return n==null||isNaN(n)?'â€”':Math.round(n).toLocaleString('en-GB'); }
function fmtC(n){ return n==null||isNaN(n)?'â€”':'Â£'+Math.round(n).toLocaleString('en-GB'); }
function fmtCPA(n){ return !n||isNaN(n)?'â€”':'Â£'+Math.round(n).toLocaleString('en-GB'); }
function fmtP(n){ return n==null||isNaN(n)?'â€”':(n*100).toFixed(1)+'%'; }
function fmtV(n){ if(n==null||isNaN(n)) return 'â€”'; return (n>=0?'+':'')+((n*100).toFixed(1))+'%'; }

// Group records by a field value
function groupBy(recs,f){ const g={}; for(const r of recs){ const k=gs(r,f); if(k){ if(!g[k]) g[k]=[]; g[k].push(r); } } return g; }

// Filter helpers
function applyGlobalFilters(recs) {
  const periodSel = document.getElementById('selPeriod').value;
  const weekSel = document.getElementById('selWeek').value;
  const rgSel = document.getElementById('selRegionGroup').value;
  const range = document.getElementById('selRange').value;

  // Period filter (apply first so YTD doesn't block it)
  if (periodSel !== 'all') recs = recs.filter(r => gs(r,'âš™ï¸ Period') === periodSel);

  // Week filter
  if (weekSel !== 'all') recs = recs.filter(r => gs(r,'âš™ï¸ Week') === weekSel);

  // Quarter filter
  if (range !== 'full' && range !== 'ytd' && Q_PERIODS[range]) {
    const allowed = new Set(Q_PERIODS[range]);
    recs = recs.filter(r => allowed.has(gs(r,'âš™ï¸ Period')));
  }
  // YTD filter â€” only apply when no specific period/week is selected
  if (range === 'ytd' && periodSel === 'all' && weekSel === 'all') recs = recs.filter(r => hasActualData([r]));

  // Region Group filter
  if (rgSel !== 'all') {
    const regionsInGroup = REG_IN_GROUP[rgSel] || [];
    recs = recs.filter(r => regionsInGroup.includes(gs(r,'âš™ï¸ Region')) || gs(r,'âš™ï¸ Region Group') === rgSel);
  }

  // Region filter
  const regSel = document.getElementById('selRegion').value;
  if (regSel !== 'all') recs = recs.filter(r => gs(r,'âš™ï¸ Region') === regSel);

  // Channel filter
  const chanSel = document.getElementById('selChannel').value;
  if (chanSel !== 'all') recs = recs.filter(r => gs(r,'âš™ï¸ Channel') === chanSel);

  return recs;
}

function getFiltered() {
  // Use Region level for all tabs â€” aggregation happens in JS
  let recs = STATE.records.filter(r => gs(r,'âš™ï¸ Level') === 'Region');
  return applyGlobalFilters(recs);
}

function getPeriodsWithData(recs) {
  const byP = groupBy(recs,'âš™ï¸ Period');
  return PERIODS.filter(p => byP[p] && byP[p].some(r => gv(r,'ğŸ”´ğŸ¶ Sales')>0 || gv(r,'ğŸ”´ğŸ± Sales')>0));
}

// Quarter to period/week mapping
const Q_PERIODS = { Q1:['P1','P2','P3'], Q2:['P4','P5','P6'], Q3:['P7','P8','P9'], Q4:['P10','P11','P12','P13'] };
const Q_WEEKS = { Q1: WEEKS.slice(0,13), Q2: WEEKS.slice(13,26), Q3: WEEKS.slice(26,39), Q4: WEEKS.slice(39,52) };

// Check if a time bucket has actual data (not future/empty)
function hasActualData(recs) {
  return recs.some(r => gv(r,'ğŸ”´ğŸ¶ Sales')>0 || gv(r,'ğŸ”´ğŸ± Sales')>0);
}

// Time axis helper â€” returns { field, labels, grouped } based on view + range
function getTimeAxis(recs) {
  const view = document.getElementById('selView').value;
  const field = view === 'week' ? 'âš™ï¸ Week' : 'âš™ï¸ Period';
  const allLabels = view === 'week' ? WEEKS : PERIODS;
  const grouped = groupBy(recs, field);

  // Show all labels that have data in the (already filtered) records
  const labels = allLabels.filter(t => grouped[t] && grouped[t].length > 0);

  return { field, labels, grouped };
}

function onViewChange() {
  render();
}

// Get brand-aware field values
function bSales(recs,prefix) {
  const b = STATE.brand;
  if(b==='butternut') return sum(recs,`${prefix}ğŸ¶ Sales`);
  if(b==='marro') return sum(recs,`${prefix}ğŸ± Sales`);
  return sum(recs,`${prefix}ğŸ¶ Sales`) + sum(recs,`${prefix}ğŸ± Sales`);
}
function bSpend(recs,prefix) {
  const b = STATE.brand;
  if(b==='butternut') return sum(recs,`${prefix}ğŸ¶ Spend`);
  if(b==='marro') return sum(recs,`${prefix}ğŸ± Spend`);
  return sum(recs,`${prefix}ğŸ¶ Spend`) + sum(recs,`${prefix}ğŸ± Spend`);
}
function bCPA(recs,prefix) {
  const sales = bSales(recs,prefix), spend = bSpend(recs,prefix);
  return sales > 0 ? spend / sales : 0;
}
function bSPS(recs,prefix) {
  const b = STATE.brand;
  if(b==='butternut') return avg(recs,`${prefix}ğŸ¶ SPS`);
  if(b==='marro') return avg(recs,`${prefix}ğŸ± SPS`);
  return (avg(recs,`${prefix}ğŸ¶ SPS`) + avg(recs,`${prefix}ğŸ± SPS`)) / 2;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KPI CARD BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function kpi(label,value,budLbl,budVal,variance,icon,color,invertVar) {
  const pos = variance!=null ? (invertVar ? variance<=0 : variance>=0) : true;
  return `<div class="kpi"><div class="stripe" style="background:${color}"></div><div class="icon">${icon}</div>
    <div class="label">${label}</div><div class="value">${value}</div>
    ${budLbl?`<div class="compare">${budLbl}: <b>${budVal}</b></div>`:''}
    ${variance!=null?`<div class="var ${pos?'pos':'neg'}">${fmtV(variance)}</div>`:''}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHART HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function destroyChart(id) { if(STATE.charts[id]) { STATE.charts[id].destroy(); delete STATE.charts[id]; } }

function shouldShowLabels() {
  // Show data labels when <= 13 data points (period view or quarter), hide for full weekly
  const view = document.getElementById('selView').value;
  const range = document.getElementById('selRange').value;
  if (view === 'period') return true;
  if (range !== 'ytd' && range !== 'full') return true; // quarter = ~13 weeks, ok
  return false; // full year weekly = too many
}

function makeBarChart(id, labels, datasets, opts={}) {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if(!ctx) return;
  const showLbl = shouldShowLabels();
  const dlFmt = opts.yFmt || (v=>fmt(v));
  STATE.charts[id] = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ top:30 } },
      interaction:{ intersect:false, mode:'index' },
      plugins:{
        legend:{ position:'bottom', labels:{ usePointStyle:true, padding:14, font:{size:11,weight:'600'} } },
        datalabels:{ display:showLbl, anchor:'end', align:'top', font:{size:13,weight:'700'}, color:function(ctx){return ctx.dataset.borderColor||ctx.dataset.backgroundColor||'#555'}, formatter: dlFmt },
      },
      scales:{
        x:{ grid:{display:false}, ticks:{font:{size:labels.length>20?8:11}} },
        y:{ beginAtZero:true, ticks:{ callback: opts.yFmt || (v=>fmt(v)) }, grid:{color:'rgba(0,0,0,.04)'} },
      },
    },
    plugins: [ChartDataLabels],
  });
}

function makeLineChart(id, labels, datasets, opts={}) {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if(!ctx) return;
  const showLbl = shouldShowLabels();
  const dlFmt = opts.yFmt || (v=>fmtC(v));
  STATE.charts[id] = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ top:30 } },
      interaction:{ intersect:false, mode:'index' },
      plugins:{
        legend:{ position:'bottom', labels:{ usePointStyle:true, padding:14, font:{size:11,weight:'600'} } },
        datalabels:{ display:showLbl, anchor:'end', align:'top', font:{size:13,weight:'700'}, color:function(ctx){return ctx.dataset.borderColor||'#555'}, formatter: dlFmt },
      },
      scales:{
        x:{ grid:{display:false}, ticks:{font:{size:labels.length>20?8:11}} },
        y:{ beginAtZero: opts.zero!==false, ticks:{ callback: opts.yFmt || (v=>fmtC(v)) }, grid:{color:'rgba(0,0,0,.04)'} },
      },
    },
    plugins: [ChartDataLabels],
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: SUMMARY TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSummary() {
  const recs = getFiltered();
  const { labels, grouped } = getTimeAxis(recs);
  const col = C[STATE.brand];
  const view = document.getElementById('selView').value;
  document.getElementById('summaryTitle').textContent = view === 'week' ? 'Weekly Performance' : 'Period Performance';

  // KPIs â€” aggregate across all filtered records
  const salesA = bSales(recs,'ğŸ”´'), salesB = bSales(recs,'ğŸ”µ');
  const spendA = bSpend(recs,'ğŸ”´'), spendB = bSpend(recs,'ğŸ”µ');
  const cpaA = salesA>0?spendA/salesA:0, cpaB = salesB>0?spendB/salesB:0;
  const spsA = bSPS(recs,'ğŸ”´'), spsB = bSPS(recs,'ğŸ”µ');
  const acqVar = salesB>0?(salesA-salesB)/salesB:null;
  const spVar = spendB>0?(spendA-spendB)/spendB:null;
  const cpaVar = cpaB>0?(cpaA-cpaB)/cpaB:null;

  // Dynamic scope label
  const pSel = document.getElementById('selPeriod').value;
  const wSel = document.getElementById('selWeek').value;
  const rngSel = document.getElementById('selRange').value;
  const scope = pSel !== 'all' ? pSel : wSel !== 'all' ? wSel : rngSel === 'ytd' ? 'YTD' : rngSel === 'full' ? 'Full Year' : rngSel;

  document.getElementById('summaryKPIs').innerHTML =
    kpi(`ğŸ”´ Sales (${scope})`,fmt(salesA),'ğŸ”µ Budget',fmt(salesB),acqVar,'ğŸ“ˆ',col.act) +
    kpi(`ğŸ”´ Spend (${scope})`,fmtC(spendA),'ğŸ”µ Budget',fmtC(spendB),spVar,'ğŸ’°',col.bud,true) +
    kpi(`ğŸ”´ CPA (${scope})`,fmtCPA(cpaA),'ğŸ”µ Budget',fmtCPA(cpaB),cpaVar,'ğŸ¯',col.fcst,true) +
    kpi(`ğŸ”´ SPS (${scope})`,spsA.toFixed(1),'ğŸ”µ Budget',spsB.toFixed(1),spsB>0?(spsA-spsB)/spsB:null,'âš¡',col.act);

  // Sales by time axis
  makeBarChart('cSalesPeriod', labels, [
    { label:'ğŸ”µ Budget', data:labels.map(t=>bSales(grouped[t]||[],'ğŸ”µ')), backgroundColor:col.bud+'66', borderColor:col.bud, borderWidth:2 },
    { label:'ğŸ”´ Actual', data:labels.map(t=>bSales(grouped[t]||[],'ğŸ”´')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:2 },
    { label:'ğŸŸ¡ Forecast', data:labels.map(t=>bSales(grouped[t]||[],'ğŸŸ¡')), type:'line', borderColor:col.fcst, backgroundColor:'transparent', borderWidth:3, borderDash:[6,3], pointRadius:view==='week'?2:4, pointBackgroundColor:col.fcst, tension:.3, order:-1 },
  ]);

  // CPA by time axis
  makeLineChart('cCPAPeriod', labels, [
    { label:'ğŸ”µ Budget CPA', data:labels.map(t=>bCPA(grouped[t]||[],'ğŸ”µ')), borderColor:col.bud, borderWidth:3, borderDash:[8,4], pointRadius:view==='week'?2:4, pointBackgroundColor:col.bud, tension:.3 },
    { label:'ğŸ”´ Actual CPA', data:labels.map(t=>bCPA(grouped[t]||[],'ğŸ”´')), borderColor:col.act, borderWidth:3, pointRadius:view==='week'?2:5, pointBackgroundColor:col.act, tension:.3 },
  ], { zero:false });

  // Cumulative spend
  let cumB=0, cumA=0;
  const cumBData=[], cumAData=[];
  for(const t of labels) { cumB+=bSpend(grouped[t]||[],'ğŸ”µ'); cumA+=bSpend(grouped[t]||[],'ğŸ”´'); cumBData.push(cumB); cumAData.push(cumA); }
  makeLineChart('cSpendCum', labels, [
    { label:'ğŸ”µ Budget', data:cumBData, borderColor:col.bud, borderWidth:3, borderDash:[8,4], fill:true, backgroundColor:col.bud+'15', tension:.3, pointRadius:view==='week'?0:3 },
    { label:'ğŸ”´ Actual', data:cumAData, borderColor:col.act, borderWidth:3, fill:true, backgroundColor:col.act+'20', tension:.3, pointRadius:view==='week'?0:3 },
  ]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: SALES & CPA TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARED: REGION DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const REG_COLOURS = {
  LDN:'#10507C', BRI:'#3A7CA5', EXE:'#6BAED6',
  MCR:'#ED6961', NWC:'#C0392B', SCOT:'#E74C3C',
  DUB:'#27AE60', CRK:'#2ECC71', BF:'#1ABC9C',
};
const REG_GROUP_ORDER = ['SOUTH','NORTH','IE F2F Group'];
const REG_IN_GROUP = {
  SOUTH: ['LDN','BRI','EXE'],
  NORTH: ['MCR','NWC','SCOT'],
  'IE F2F Group': ['DUB','CRK','BF'],
};
const REG_EMOJI = { LDN:'ğŸ™ï¸', BRI:'âš“', EXE:'ğŸŒŠ', MCR:'ğŸ', NWC:'ğŸ”ï¸', SCOT:'ğŸ´', DUB:'â˜˜ï¸', CRK:'ğŸ‡®ğŸ‡ª', BF:'ğŸ€' };

function makeStackedChart(id, labels, datasets) {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if(!ctx) return;
  STATE.charts[id] = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{ intersect:false, mode:'index' },
      plugins:{
        legend:{ position:'bottom', labels:{ usePointStyle:true, padding:14, font:{size:11,weight:'600'} } },
        datalabels:{ display:false },
      },
      scales:{
        x:{ stacked:true, grid:{display:false}, ticks:{font:{size:labels.length>20?8:11}} },
        y:{ stacked:true, beginAtZero:true, grid:{color:'rgba(0,0,0,.04)'} },
      },
    },
  });
}

function makeRegionLineChart(id, labels, regions, byTime, metricFn, fmtFn) {
  destroyChart(id);
  const ctx = document.getElementById(id);
  if(!ctx) return;
  const datasets = regions.map(reg => ({
    label: `${REG_EMOJI[reg]||'ğŸ“'} ${reg}`,
    data: labels.map(t => {
      const recs = (byTime[t]||[]).filter(r=>gs(r,'âš™ï¸ Region')===reg);
      return metricFn(recs);
    }),
    borderColor: REG_COLOURS[reg]||'#999',
    backgroundColor: 'transparent',
    borderWidth: 2,
    pointRadius: labels.length>20?1:4,
    pointBackgroundColor: REG_COLOURS[reg]||'#999',
    tension: .3,
  }));
  STATE.charts[id] = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{ intersect:false, mode:'index' },
      plugins:{
        legend:{ position:'bottom', labels:{ usePointStyle:true, padding:14, font:{size:11,weight:'600'} } },
        datalabels:{ display:false },
      },
      scales:{
        x:{ grid:{display:false}, ticks:{font:{size:labels.length>20?8:11}} },
        y:{ beginAtZero:false, ticks:{callback:fmtFn}, grid:{color:'rgba(0,0,0,.04)'} },
      },
    },
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: SALES & CPA TAB
// Region group sections with KPI cards, Budget (single) vs
// Actual (stacked by region in red shades), CPA lines, data labels
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Red shades for stacking actual bars within each region group
// Distinct colours per region â€” high contrast, not just red shades
const RED_SHADES = {
  SOUTH: { LDN:'#C0392B', BRI:'#E67E22', EXE:'#F39C12' },
  NORTH: { MCR:'#8E44AD', NWC:'#E74C3C', SCOT:'#D35400' },
  'IE F2F Group': { DUB:'#27AE60', CRK:'#2ECC71', BF:'#16A085' },
};

function getFilteredRegionRecs() {
  let recs = STATE.records.filter(r => gs(r,'âš™ï¸ Level') === 'Region');
  return applyGlobalFilters(recs);
}

function renderSales() {
  const recs = getFilteredRegionRecs();
  const col = C[STATE.brand];
  const view = document.getElementById('selView').value;
  const { labels, grouped: byTime } = getTimeAxis(recs);
  const byRegion = groupBy(recs,'âš™ï¸ Region');

  // Overall KPIs
  const salesA=bSales(recs,'ğŸ”´'), salesB=bSales(recs,'ğŸ”µ'), spendA=bSpend(recs,'ğŸ”´'), spendB=bSpend(recs,'ğŸ”µ');
  const cpaA=salesA>0?spendA/salesA:0, cpaB=salesB>0?spendB/salesB:0;
  const pS = document.getElementById('selPeriod').value;
  const wS = document.getElementById('selWeek').value;
  const rS = document.getElementById('selRange').value;
  const scp = pS !== 'all' ? pS : wS !== 'all' ? wS : rS === 'ytd' ? 'YTD' : rS === 'full' ? 'Full Year' : rS;

  document.getElementById('salesKPIs').innerHTML =
    kpi(`ğŸ”´ Sales (${scp})`,fmt(salesA),'ğŸ”µ Budget',fmt(salesB),salesB>0?(salesA-salesB)/salesB:null,'ğŸ“ˆ',col.act) +
    kpi(`ğŸ”´ CPA (${scp})`,fmtCPA(cpaA),'ğŸ”µ Budget',fmtCPA(cpaB),cpaB>0?(cpaA-cpaB)/cpaB:null,'ğŸ¯',col.bud,true) +
    kpi(`ğŸ”´ Spend (${scp})`,fmtC(spendA),'ğŸ”µ Budget',fmtC(spendB),spendB>0?(spendA-spendB)/spendB:null,'ğŸ’°',col.fcst,true);

  // Build HTML for region group sections
  let html = '';
  let chartIdx = 0;
  for (const grp of REG_GROUP_ORDER) {
    const regions = (REG_IN_GROUP[grp]||[]).filter(r => byRegion[r]);
    if (!regions.length) continue;
    const grpRecs = recs.filter(r => regions.includes(gs(r,'âš™ï¸ Region')));
    const gSalesA=bSales(grpRecs,'ğŸ”´'), gSalesB=bSales(grpRecs,'ğŸ”µ'), gSpendA=bSpend(grpRecs,'ğŸ”´'), gSpendB=bSpend(grpRecs,'ğŸ”µ');
    const gCpaA=gSalesA>0?gSpendA/gSalesA:0, gCpaB=gSalesB>0?gSpendB/gSalesB:0;

    html += `<div class="section-hdr"><h2>${grp}</h2><div class="line"></div></div>`;
    // KPI cards per region group
    html += `<div class="kpi-row">`;
    html += kpi('Sales',fmt(gSalesA),'ğŸ”µ Budget',fmt(gSalesB),gSalesB>0?(gSalesA-gSalesB)/gSalesB:null,'ğŸ“ˆ',col.act);
    html += kpi('CPA',fmtCPA(gCpaA),'ğŸ”µ Budget',fmtCPA(gCpaB),gCpaB>0?(gCpaA-gCpaB)/gCpaB:null,'ğŸ¯',col.bud,true);
    // Per-region mini cards
    for (const reg of regions) {
      const rr = byRegion[reg]||[];
      const rs=bSales(rr,'ğŸ”´'), rb=bSales(rr,'ğŸ”µ');
      html += kpi(reg,fmt(rs),'Budget',fmt(rb),rb>0?(rs-rb)/rb:null,'',RED_SHADES[grp]?.[reg]||col.act);
    }
    html += `</div>`;
    // Chart canvases
    const salesId=`cSR_${chartIdx++}`, cpaId=`cSR_${chartIdx++}`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” Sales: Budget vs Actual by Region</h3><div class="chart-wrap"><canvas id="${salesId}"></canvas></div></div></div>`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” CPA by Region</h3><div class="chart-wrap"><canvas id="${cpaId}"></canvas></div></div></div>`;
  }
  document.getElementById('salesRegionCharts').innerHTML = html;

  // Render charts
  chartIdx = 0;
  for (const grp of REG_GROUP_ORDER) {
    const regions = (REG_IN_GROUP[grp]||[]).filter(r => byRegion[r]);
    if (!regions.length) continue;
    const shades = RED_SHADES[grp]||{};

    // SALES: Budget (single blue bar) + Actual stacked by region (red shades)
    const salesId = `cSR_${chartIdx++}`;
    const budgetDS = {
      label:'ğŸ”µ Budget (Total)',
      data: labels.map(t => {
        const tRecs = (byTime[t]||[]).filter(r=>regions.includes(gs(r,'âš™ï¸ Region')));
        return bSales(tRecs,'ğŸ”µ');
      }),
      backgroundColor: col.bud+'88',
      borderColor: col.bud,
      borderWidth: 2,
      stack: 'budget',
    };
    const actualDS = regions.map(reg => ({
      label: `${REG_EMOJI[reg]||'ğŸ“'} ${reg}`,
      data: labels.map(t => {
        const tRecs = (byTime[t]||[]).filter(r=>gs(r,'âš™ï¸ Region')===reg);
        return bSales(tRecs,'ğŸ”´');
      }),
      backgroundColor: (shades[reg]||'#ED6961')+'DD',
      borderColor: shades[reg]||'#ED6961',
      borderWidth: 1,
      stack: 'actual',
    }));
    destroyChart(salesId);
    const ctx1 = document.getElementById(salesId);
    if(ctx1) {
      const showLbl = labels.length <= 13;
      STATE.charts[salesId] = new Chart(ctx1, {
        type:'bar',
        data:{ labels, datasets: [budgetDS, ...actualDS] },
        options:{
responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ top:30 } },
      interaction:{ intersect:false, mode:'index' },
      plugins:{
        legend:{ position:'bottom', labels:{ usePointStyle:true, padding:14, font:{size:11,weight:'600'} } },
        datalabels:{ display:showLbl, anchor:'end', align:'top', font:{size:12,weight:'700'},
              color:function(c){return c.dataset.borderColor||'#555'},
              formatter:v=>v>0?fmt(v):'',
            },
          },
          scales:{
            x:{ stacked:true, grid:{display:false}, ticks:{font:{size:labels.length>20?8:11}} },
            y:{ stacked:true, beginAtZero:true, grid:{color:'rgba(0,0,0,.04)'} },
          },
        },
        plugins:[ChartDataLabels],
      });
    }

    // CPA: line per region with data labels
    const cpaId = `cSR_${chartIdx++}`;
    destroyChart(cpaId);
    const ctx2 = document.getElementById(cpaId);
    if(ctx2) {
      const showLbl = labels.length <= 13;
      const cpaDS = regions.map(reg => ({
        label: `${REG_EMOJI[reg]||'ğŸ“'} ${reg}`,
        data: labels.map(t => {
          const tRecs = (byTime[t]||[]).filter(r=>gs(r,'âš™ï¸ Region')===reg);
          return bCPA(tRecs,'ğŸ”´');
        }),
        borderColor: shades[reg]||REG_COLOURS[reg]||'#999',
        backgroundColor: 'transparent',
        borderWidth: 2.5,
        pointRadius: labels.length>20?2:5,
        pointBackgroundColor: shades[reg]||REG_COLOURS[reg]||'#999',
        tension: .3,
      }));
      // Budget CPA line (dashed blue)
      const budCPA = {
        label: 'ğŸ”µ Budget CPA',
        data: labels.map(t => {
          const tRecs = (byTime[t]||[]).filter(r=>regions.includes(gs(r,'âš™ï¸ Region')));
          return bCPA(tRecs,'ğŸ”µ');
        }),
        borderColor: col.bud,
        backgroundColor: 'transparent',
        borderWidth: 3,
        borderDash: [8,4],
        pointRadius: labels.length>20?1:4,
        pointBackgroundColor: col.bud,
        tension: .3,
      };
      STATE.charts[cpaId] = new Chart(ctx2, {
        type:'line',
        data:{ labels, datasets: [budCPA, ...cpaDS] },
        options:{
responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ top:30 } },
      interaction:{ intersect:false, mode:'index' },
      plugins:{
        legend:{ position:'bottom', labels:{ usePointStyle:true, padding:14, font:{size:11,weight:'600'} } },
        datalabels:{ display:showLbl, anchor:'end', align:'top', font:{size:11,weight:'700'},
              color:function(c){return c.dataset.borderColor||'#555'},
              formatter:v=>v>0?fmtCPA(v):'',
            },
          },
          scales:{
            x:{ grid:{display:false}, ticks:{font:{size:labels.length>20?8:11}} },
            y:{ beginAtZero:false, ticks:{callback:v=>fmtCPA(v)}, grid:{color:'rgba(0,0,0,.04)'} },
          },
        },
        plugins:[ChartDataLabels],
      });
    }
  }

  // Period detail table
  let h=`<thead><tr><th>${view==='week'?'Week':'Period'}</th><th>ğŸ”µğŸ¶ Sales</th><th>ğŸ”´ğŸ¶ Actual</th><th>ğŸ¶ Var%</th><th>ğŸ”µğŸ± Sales</th><th>ğŸ”´ğŸ± Actual</th><th>ğŸ± Var%</th><th>ğŸ”´ğŸ¶ CPA</th><th>ğŸ”´ğŸ± CPA</th></tr></thead><tbody>`;
  for(const t of labels) {
    const r=byTime[t]||[];
    const bs=sum(r,'ğŸ”µğŸ¶ Sales'),ba2=sum(r,'ğŸ”´ğŸ¶ Sales'),ms2=sum(r,'ğŸ”µğŸ± Sales'),ma2=sum(r,'ğŸ”´ğŸ± Sales');
    const bv=bs>0?(ba2-bs)/bs:0, mv=ms2>0?(ma2-ms2)/ms2:0;
    const bc2=sum(r,'ğŸ”´ğŸ¶ Spend'),mc2=sum(r,'ğŸ”´ğŸ± Spend');
    h+=`<tr><td>${t}</td><td>${fmt(bs)}</td><td>${fmt(ba2)}</td><td class="${bv>=0?'pos':'neg'}">${fmtV(bv)}</td><td>${fmt(ms2)}</td><td>${fmt(ma2)}</td><td class="${mv>=0?'pos':'neg'}">${fmtV(mv)}</td><td>${fmtCPA(ba2>0?bc2/ba2:0)}</td><td>${fmtCPA(ma2>0?mc2/ma2:0)}</td></tr>`;
  }
  h+='</tbody>';
  document.getElementById('tblPeriod').innerHTML = h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: REGIONAL TAB (summary totals, controlled by filters)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRegions() {
  // Get ALL region-level records (unfiltered by range) for full year budget/forecast
  const allRegRecs = applyGlobalFilters(STATE.records.filter(r => gs(r,'âš™ï¸ Level') === 'Region'));
  // Get only records with actual data for "actuals" metrics
  const actualRecs = allRegRecs.filter(r => hasActualData([r]));
  const col = C[STATE.brand];

  // Overall KPIs
  const salesB = bSales(allRegRecs,'ğŸ”µ'), salesF = bSales(allRegRecs,'ğŸŸ¡'), salesA = bSales(actualRecs,'ğŸ”´');
  const spendB = bSpend(allRegRecs,'ğŸ”µ'), spendA = bSpend(actualRecs,'ğŸ”´');
  const cpaB = salesB>0?spendB/salesB:0, cpaA = salesA>0?spendA/salesA:0;
  // Dynamic labels based on active filters
  const periodSel = document.getElementById('selPeriod').value;
  const weekSel = document.getElementById('selWeek').value;
  const rangeSel = document.getElementById('selRange').value;
  const scope = periodSel !== 'all' ? periodSel : weekSel !== 'all' ? weekSel : rangeSel === 'ytd' ? 'YTD' : rangeSel === 'full' ? 'Full Year' : rangeSel;

  document.getElementById('regionOverallKPIs').innerHTML =
    kpi(`ğŸ”µ Budget Sales (${scope})`,fmt(salesB),scope,'',null,'ğŸ“Š',col.bud) +
    kpi(`ğŸŸ¡ Forecast Sales (${scope})`,fmt(salesF),scope,'',salesB>0?(salesF-salesB)/salesB:null,'ğŸ”®',col.fcst) +
    kpi(`ğŸ”´ Actual Sales (${scope})`,fmt(salesA),'vs Budget',fmt(salesB),salesB>0?(salesA-salesB)/salesB:null,'ğŸ“ˆ',col.act) +
    kpi('ğŸ”´ Actual CPA',fmtCPA(cpaA),'ğŸ”µ Budget CPA',fmtCPA(cpaB),cpaB>0?(cpaA-cpaB)/cpaB:null,'ğŸ¯',col.bud,true);

  // Build per-region-group sections
  let html = '';
  let chartIdx = 0;
  const byRegionAll = groupBy(allRegRecs,'âš™ï¸ Region');
  const byRegionAct = groupBy(actualRecs,'âš™ï¸ Region');

  for (const grp of REG_GROUP_ORDER) {
    const regions = (REG_IN_GROUP[grp]||[]).filter(r => byRegionAll[r]);
    if (!regions.length) continue;

    html += `<div class="section-hdr"><h2>${grp}</h2><div class="line"></div></div>`;

    // KPI cards per region
    html += `<div class="kpi-row">`;
    for (const reg of regions) {
      const rAll = byRegionAll[reg]||[], rAct = byRegionAct[reg]||[];
      const rBud = bSales(rAll,'ğŸ”µ'), rFcst = bSales(rAll,'ğŸŸ¡'), rActS = bSales(rAct,'ğŸ”´');
      const rCpaA = bCPA(rAct,'ğŸ”´'), rCpaB = bCPA(rAll,'ğŸ”µ');
      const rSps = bSPS(rAct,'ğŸ”´');
      const rTeam = avg(rAct,'ğŸ”´ Total Team Size');
      html += `<div class="kpi" style="min-width:220px"><div class="stripe" style="background:${REG_COLOURS[reg]||col.act}"></div>
        <div class="label">${reg}</div>
        <div style="display:flex;gap:16px;margin-top:6px">
          <div><div style="font-size:10px;color:var(--text2)">ğŸ”µ Budget</div><div style="font-size:16px;font-weight:800">${fmt(rBud)}</div></div>
          <div><div style="font-size:10px;color:var(--text2)">ğŸŸ¡ Forecast</div><div style="font-size:16px;font-weight:800;color:${col.fcst}">${fmt(rFcst)}</div></div>
          <div><div style="font-size:10px;color:var(--text2)">ğŸ”´ Actual</div><div style="font-size:16px;font-weight:800;color:${col.act}">${fmt(rActS)}</div></div>
        </div>
        <div style="margin-top:6px;font-size:11px;color:var(--text2)">CPA: ${fmtCPA(rCpaA)} (Bdg: ${fmtCPA(rCpaB)}) | SPS: ${rSps.toFixed(1)} | Team: ${fmt(rTeam)}</div>
        ${rBud>0?`<div class="var ${rActS>=rBud?'pos':'neg'}" style="margin-top:3px">${fmtV((rActS-rBud)/rBud)} actual vs budget</div>`:''}
      </div>`;
    }
    html += `</div>`;

    // Charts: Sales comparison and CPA comparison
    const cSales = `cRS_${chartIdx++}`, cCPA = `cRS_${chartIdx++}`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” Sales: Budget vs Forecast vs Actual</h3><div class="chart-wrap"><canvas id="${cSales}"></canvas></div></div></div>`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” CPA: Budget vs Actual</h3><div class="chart-wrap"><canvas id="${cCPA}"></canvas></div></div></div>`;
  }

  document.getElementById('regionGroupSections').innerHTML = html;

  // Render charts
  chartIdx = 0;
  for (const grp of REG_GROUP_ORDER) {
    const regions = (REG_IN_GROUP[grp]||[]).filter(r => byRegionAll[r]);
    if (!regions.length) continue;

    // Sales: grouped bars per region â€” Budget, Forecast, Actual
    const cSales = `cRS_${chartIdx++}`;
    destroyChart(cSales);
    const ctx1 = document.getElementById(cSales);
    if (ctx1) {
      STATE.charts[cSales] = new Chart(ctx1, {
        type:'bar',
        data:{ labels:regions, datasets:[
          { label:'ğŸ”µ Budget', data:regions.map(r=>bSales(byRegionAll[r]||[],'ğŸ”µ')), backgroundColor:col.bud+'88', borderColor:col.bud, borderWidth:2 },
          { label:'ğŸŸ¡ Forecast', data:regions.map(r=>bSales(byRegionAll[r]||[],'ğŸŸ¡')), backgroundColor:col.fcst+'88', borderColor:col.fcst, borderWidth:2 },
          { label:'ğŸ”´ Actual (YTD)', data:regions.map(r=>bSales(byRegionAct[r]||[],'ğŸ”´')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:2 },
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          layout:{ padding:{ top:30 } },
          plugins:{ legend:{ position:'bottom', labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}} },
            datalabels:{ display:true, anchor:'end', align:'top', font:{size:13,weight:'700'}, color:function(c){return c.dataset.borderColor||'#555'}, formatter:v=>v>0?fmt(v):'' },
          },
          scales:{ x:{grid:{display:false}}, y:{beginAtZero:true,grid:{color:'rgba(0,0,0,.04)'}} },
        },
        plugins:[ChartDataLabels],
      });
    }

    // CPA: grouped bars per region â€” Budget vs Actual
    const cCPA = `cRS_${chartIdx++}`;
    destroyChart(cCPA);
    const ctx2 = document.getElementById(cCPA);
    if (ctx2) {
      STATE.charts[cCPA] = new Chart(ctx2, {
        type:'bar',
        data:{ labels:regions, datasets:[
          { label:'ğŸ”µ Budget CPA', data:regions.map(r=>bCPA(byRegionAll[r]||[],'ğŸ”µ')), backgroundColor:col.bud+'88', borderColor:col.bud, borderWidth:2 },
          { label:'ğŸ”´ Actual CPA', data:regions.map(r=>bCPA(byRegionAct[r]||[],'ğŸ”´')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:2 },
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          layout:{ padding:{ top:30 } },
          plugins:{ legend:{ position:'bottom', labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}} },
            datalabels:{ display:true, anchor:'end', align:'top', font:{size:13,weight:'700'}, color:function(c){return c.dataset.borderColor||'#555'}, formatter:v=>v>0?fmtCPA(v):'' },
          },
          scales:{ x:{grid:{display:false}}, y:{beginAtZero:true,ticks:{callback:v=>fmtCPA(v)},grid:{color:'rgba(0,0,0,.04)'}} },
        },
        plugins:[ChartDataLabels],
      });
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: RETENTION TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRetention() {
  // Combine 2025 + 2026 region-level records
  const all2025 = (STATE.records2025||[]).filter(r => gs(r,'âš™ï¸ Level') === 'Region');
  const all2026 = STATE.records.filter(r => gs(r,'âš™ï¸ Level') === 'Region');
  let allRecs = [...all2025, ...all2026];

  // Filter to âœ… (matured) and â³ (almost matured)
  allRecs = allRecs.filter(r => { const t=gs(r,'âœ… 28 day retention week Tick'); return t==='âœ…'||t==='â³'; });

  // Apply region group + region filters
  const rgSel = document.getElementById('selRegionGroup').value;
  const regSel = document.getElementById('selRegion').value;
  if (rgSel !== 'all') { const rg=REG_IN_GROUP[rgSel]||[]; allRecs=allRecs.filter(r=>rg.includes(gs(r,'âš™ï¸ Region'))||gs(r,'âš™ï¸ Region Group')===rgSel); }
  if (regSel !== 'all') allRecs = allRecs.filter(r => gs(r,'âš™ï¸ Region') === regSel);

  const col = C[STATE.brand];
  const byRegion = groupBy(allRecs,'âš™ï¸ Region');

  // Brand-aware helpers
  function bRet2(recs){ const b=STATE.brand; if(b==='butternut') return avg(recs,'ğŸ”´ğŸ¶ Box 2 Retention'); if(b==='marro') return avg(recs,'ğŸ”´ğŸ± Box 2 Retention'); return (avg(recs,'ğŸ”´ğŸ¶ Box 2 Retention')+avg(recs,'ğŸ”´ğŸ± Box 2 Retention'))/2; }
  function bRet3(recs){ const b=STATE.brand; if(b==='butternut') return avg(recs,'ğŸ”´ğŸ¶ Box 3 Retention'); if(b==='marro') return avg(recs,'ğŸ”´ğŸ± Box 3 Retention'); return (avg(recs,'ğŸ”´ğŸ¶ Box 3 Retention')+avg(recs,'ğŸ”´ğŸ± Box 3 Retention'))/2; }
  function bBox1(recs){ const b=STATE.brand; if(b==='butternut') return sum(recs,'ğŸ”´ğŸ¶ Box 1 Count'); if(b==='marro') return sum(recs,'ğŸ”´ğŸ± Box 1 Count'); return sum(recs,'ğŸ”´ğŸ¶ Box 1 Count')+sum(recs,'ğŸ”´ğŸ± Box 1 Count'); }
  function bDisc(recs){ const b=STATE.brand; if(b==='butternut') return avg(recs,'ğŸ”´ğŸ¶ Box 1 Average Discount'); if(b==='marro') return avg(recs,'ğŸ”´ğŸ± Box 1 Average Discount'); return (avg(recs,'ğŸ”´ğŸ¶ Box 1 Average Discount')+avg(recs,'ğŸ”´ğŸ± Box 1 Average Discount'))/2; }

  // Sort all records chronologically and build week labels
  allRecs.sort((a,b) => { const ya=gs(a,'âš™ï¸ Year'),yb=gs(b,'âš™ï¸ Year'); if(ya!==yb) return ya<yb?-1:1; return (W_ORD[gs(a,'âš™ï¸ Week')]||0)-(W_ORD[gs(b,'âš™ï¸ Week')]||0); });
  const weekGroups = {};
  const orderedLabels = [];
  for (const r of allRecs) {
    const label = `${gs(r,'âš™ï¸ Week')}'${String(gs(r,'âš™ï¸ Year')).slice(-2)}`;
    if (!weekGroups[label]) { weekGroups[label]=[]; orderedLabels.push(label); }
    weekGroups[label].push(r);
  }
  const uniqueLabels = [...new Set(orderedLabels)];

  // Rolling 8-week window â€” take last 8 labels
  const last8 = uniqueLabels.slice(-8);
  const prevLabel = uniqueLabels.length >= 9 ? uniqueLabels[uniqueLabels.length - 9] : null;

  // Latest week and previous week for KPI tiles
  const latestLabel = last8[last8.length - 1];
  const prevWeekLabel = last8.length >= 2 ? last8[last8.length - 2] : null;
  const latestRecs = weekGroups[latestLabel] || [];
  const prevRecs = prevWeekLabel ? (weekGroups[prevWeekLabel]||[]) : [];

  // KPIs â€” latest week with WoW change
  const lRet2=bRet2(latestRecs), pRet2=bRet2(prevRecs);
  const lRet3=bRet3(latestRecs), pRet3=bRet3(prevRecs);
  const lDisc=bDisc(latestRecs), pDisc=bDisc(prevRecs);
  const lApp=avg(latestRecs,'ğŸ”´ App Download %'), pApp=avg(prevRecs,'ğŸ”´ App Download %');
  const lTM=avg(latestRecs,'ğŸ”´ Tail Mail %'), pTM=avg(prevRecs,'ğŸ”´ Tail Mail %');
  const lBox1=bBox1(latestRecs);

  function wowVar(curr,prev){ return prev>0?(curr-prev)/prev:null; }

  document.getElementById('retentionKPIs').innerHTML =
    kpi(`Box 2 Ret (${latestLabel})`,fmtP(lRet2),'Prev week',fmtP(pRet2),pRet2?lRet2-pRet2:null,'ğŸ“¦',col.act) +
    kpi(`Box 3 Ret (${latestLabel})`,fmtP(lRet3),'Prev week',fmtP(pRet3),pRet3?lRet3-pRet3:null,'ğŸ“¦','#8E44AD') +
    kpi(`Box 1 Disc (${latestLabel})`,fmtP(lDisc),'Prev week',fmtP(pDisc),pDisc?lDisc-pDisc:null,'ğŸ·ï¸',col.fcst,true) +
    kpi(`App DL (${latestLabel})`,fmtP(lApp),'Prev week',fmtP(pApp),pApp?lApp-pApp:null,'ğŸ“±',col.bud) +
    kpi(`Tail Mail (${latestLabel})`,fmtP(lTM),'Prev week',fmtP(pTM),pTM?lTM-pTM:null,'ğŸ“¬','#27AE60') +
    kpi(`Box 1 Count (${latestLabel})`,fmt(lBox1),'Volume','',null,'ğŸ“Š',col.bud);

  // Build per region group
  let html = '';
  let chartIdx = 0;

  for (const grp of REG_GROUP_ORDER) {
    const regions = (REG_IN_GROUP[grp]||[]).filter(r => byRegion[r]);
    if (!regions.length) continue;

    html += `<div class="section-hdr"><h2>${grp}</h2><div class="line"></div></div>`;

    // Region KPI cards â€” latest week
    html += `<div class="kpi-row">`;
    for (const reg of regions) {
      const regLatest = latestRecs.filter(r=>gs(r,'âš™ï¸ Region')===reg);
      const regPrev = prevRecs.filter(r=>gs(r,'âš™ï¸ Region')===reg);
      const rR2=bRet2(regLatest), rR2p=bRet2(regPrev);
      const rR3=bRet3(regLatest);
      const rD=bDisc(regLatest);
      html += `<div class="kpi" style="min-width:200px"><div class="stripe" style="background:${REG_COLOURS[reg]||col.act}"></div>
        <div class="label">${REG_EMOJI[reg]||''} ${reg} (${latestLabel})</div>
        <div style="font-size:16px;font-weight:800;margin-top:4px">B2: ${fmtP(rR2)} | B3: ${fmtP(rR3)}</div>
        <div style="font-size:11px;color:var(--text2)">Disc: ${fmtP(rD)} | App: ${fmtP(avg(regLatest,'ğŸ”´ App Download %'))}</div>
        ${rR2p?`<div class="var ${rR2>=rR2p?'pos':'neg'}" style="margin-top:2px">B2 WoW: ${fmtV(rR2p?(rR2-rR2p)/rR2p:0)}</div>`:''}
      </div>`;
    }
    html += `</div>`;

    const c1=`cRT_${chartIdx++}`, c1b=`cRT_${chartIdx++}`, c2=`cRT_${chartIdx++}`, c3=`cRT_${chartIdx++}`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” Box 2 Retention (28-day, 8 Week Rolling)</h3><div class="chart-wrap"><canvas id="${c1}"></canvas></div></div></div>`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” Box 3 Retention (56-day, 12 Week Rolling)</h3><div class="chart-wrap"><canvas id="${c1b}"></canvas></div></div></div>`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” Sales & Avg Box 1 Discount (8 Week Rolling)</h3><div class="chart-wrap"><canvas id="${c2}"></canvas></div></div></div>`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” Sales, App Download % & Tail Mail % (8 Week Rolling)</h3><div class="chart-wrap"><canvas id="${c3}"></canvas></div></div></div>`;
  }
  document.getElementById('retentionCharts').innerHTML = html;

  // Render charts â€” 8 week window
  chartIdx = 0;
  for (const grp of REG_GROUP_ORDER) {
    const regions = (REG_IN_GROUP[grp]||[]).filter(r => byRegion[r]);
    if (!regions.length) continue;
    const grpByWeek = {};
    for (const l of last8) { grpByWeek[l] = (weekGroups[l]||[]).filter(r=>regions.includes(gs(r,'âš™ï¸ Region'))); }

    // Determine maturity per week: âœ… = matured, â³ = almost
    const weekMaturity = last8.map(l => {
      const recs = grpByWeek[l]||[];
      const ticks = recs.map(r=>gs(r,'âœ… 28 day retention week Tick'));
      return ticks.every(t=>t==='âœ…') ? 'matured' : 'almost';
    });

    // Bar colours: solid for matured, faded for almost
    const barBgMatured = col.bud+'CC', barBgAlmost = col.bud+'35';
    const barBorderMatured = col.bud, barBorderAlmost = col.bud+'77';
    const barBgs = weekMaturity.map(m => m==='matured' ? barBgMatured : barBgAlmost);
    const barBorders = weekMaturity.map(m => m==='matured' ? barBorderMatured : barBorderAlmost);

    // Retention: split into matured (solid) and almost (dashed) segments
    const ret2Matured = last8.map((l,i) => weekMaturity[i]==='matured' ? bRet2(grpByWeek[l]||[]) : null);
    const ret2Almost = last8.map((l,i) => weekMaturity[i]==='almost' ? bRet2(grpByWeek[l]||[]) : null);
    // Bridge: connect last matured to first almost
    for (let i=1;i<last8.length;i++) { if(ret2Almost[i]!==null && ret2Matured[i-1]!==null) ret2Almost[i-1]=ret2Matured[i-1]; }
    for (let i=0;i<last8.length-1;i++) { if(ret2Matured[i]!==null && ret2Almost[i+1]!==null) ret2Matured[i+1]=ret2Almost[i+1]; }

    const ret3Matured = last8.map((l,i) => weekMaturity[i]==='matured' ? bRet3(grpByWeek[l]||[]) : null);
    const ret3Almost = last8.map((l,i) => weekMaturity[i]==='almost' ? bRet3(grpByWeek[l]||[]) : null);
    for (let i=1;i<last8.length;i++) { if(ret3Almost[i]!==null && ret3Matured[i-1]!==null) ret3Almost[i-1]=ret3Matured[i-1]; }
    for (let i=0;i<last8.length-1;i++) { if(ret3Matured[i]!==null && ret3Almost[i+1]!==null) ret3Matured[i+1]=ret3Almost[i+1]; }

    // Chart 1: Box 1 Count (bars with maturity shading) + Box 2 Ret + Box 3 Ret
    const c1 = `cRT_${chartIdx++}`;
    destroyChart(c1);
    const ctx1 = document.getElementById(c1);
    if(ctx1) {
      STATE.charts[c1] = new Chart(ctx1, {
        type:'bar',
        data:{ labels:last8, datasets:[
          { label:'Box 1 Count (âœ… matured)', data:last8.map(l=>bBox1(grpByWeek[l]||[])), backgroundColor:barBgs, borderColor:barBorders, borderWidth:1, yAxisID:'y' },
          { label:'Box 2 Ret (âœ… matured)', data:ret2Matured, type:'line', borderColor:col.act, backgroundColor:'transparent', borderWidth:3, pointRadius:5, pointBackgroundColor:col.act, tension:.3, yAxisID:'y1', spanGaps:true },
          { label:'Box 2 Ret (â³ almost)', data:ret2Almost, type:'line', borderColor:col.act+'88', backgroundColor:'transparent', borderWidth:3, borderDash:[6,4], pointRadius:5, pointBackgroundColor:col.act+'88', tension:.3, yAxisID:'y1', spanGaps:true },
        ]},
        options:{
          responsive:true, maintainAspectRatio:false, layout:{padding:{top:30}},
          plugins:{ legend:{position:'bottom',labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}}},
            datalabels:{display:true,font:{size:11,weight:'700'},color:function(c){return c.dataset.borderColor||'#555'},
              formatter:function(v,c){if(v===null) return ''; return c.datasetIndex>=1?fmtP(v):fmt(v)},anchor:'end',align:'top'}, },
          scales:{ x:{grid:{display:false}}, y:{beginAtZero:true,position:'left',title:{display:true,text:'Box 1 Count'},grid:{color:'rgba(0,0,0,.04)'}},
            y1:{beginAtZero:true,position:'right',max:1,ticks:{callback:v=>fmtP(v)},title:{display:true,text:'Retention %'},grid:{display:false}}, },
        }, plugins:[ChartDataLabels],
      });
    }

    // Chart 1b: Box 3 Retention (56-day, 12 week rolling window)
    const c1b = `cRT_${chartIdx++}`;
    destroyChart(c1b);
    const ctx1b = document.getElementById(c1b);
    if(ctx1b) {
      // Box 3 needs 12-week window (8-week maturity = longer lookback)
      const last12 = uniqueLabels.slice(-12);
      const grpByWeek12 = {};
      for (const l of last12) { grpByWeek12[l] = (weekGroups[l]||[]).filter(r=>regions.includes(gs(r,'âš™ï¸ Region'))); }

      const wm12 = last12.map(l => {
        const recs = grpByWeek12[l]||[];
        const ticks = recs.map(r=>gs(r,'âœ… 28 day retention week Tick'));
        return ticks.every(t=>t==='âœ…') ? 'matured' : 'almost';
      });
      const barBgs12 = wm12.map(m => m==='matured' ? col.bud+'CC' : col.bud+'35');
      const barBorders12 = wm12.map(m => m==='matured' ? col.bud : col.bud+'77');

      const r3Mat = last12.map((l,i) => wm12[i]==='matured' ? bRet3(grpByWeek12[l]||[]) : null);
      const r3Alm = last12.map((l,i) => wm12[i]==='almost' ? bRet3(grpByWeek12[l]||[]) : null);
      // Bridge maturedâ†’almost transition
      for (let i=1;i<last12.length;i++) { if(r3Alm[i]!==null && r3Mat[i-1]!==null) r3Alm[i-1]=r3Mat[i-1]; }
      for (let i=0;i<last12.length-1;i++) { if(r3Mat[i]!==null && r3Alm[i+1]!==null) r3Mat[i+1]=r3Alm[i+1]; }

      STATE.charts[c1b] = new Chart(ctx1b, {
        type:'bar',
        data:{ labels:last12, datasets:[
          { label:'Box 1 Count', data:last12.map(l=>bBox1(grpByWeek12[l]||[])), backgroundColor:barBgs12, borderColor:barBorders12, borderWidth:1, yAxisID:'y' },
          { label:'Box 3 Ret (âœ… matured)', data:r3Mat, type:'line', borderColor:'#8E44AD', backgroundColor:'transparent', borderWidth:3, pointRadius:5, pointBackgroundColor:'#8E44AD', tension:.3, yAxisID:'y1', spanGaps:true },
          { label:'Box 3 Ret (â³ almost)', data:r3Alm, type:'line', borderColor:'#8E44AD88', backgroundColor:'transparent', borderWidth:3, borderDash:[6,4], pointRadius:5, pointBackgroundColor:'#8E44AD88', tension:.3, yAxisID:'y1', spanGaps:true },
        ]},
        options:{
          responsive:true, maintainAspectRatio:false, layout:{padding:{top:30}},
          plugins:{ legend:{position:'bottom',labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}}},
            datalabels:{display:true,font:{size:11,weight:'700'},color:function(c){return c.dataset.borderColor||'#555'},
              formatter:function(v,c){if(v===null) return ''; return c.datasetIndex>=1?fmtP(v):fmt(v)},anchor:'end',align:'top'}, },
          scales:{ x:{grid:{display:false}}, y:{beginAtZero:true,position:'left',title:{display:true,text:'Box 1 Count'},grid:{color:'rgba(0,0,0,.04)'}},
            y1:{beginAtZero:true,position:'right',max:1,ticks:{callback:v=>fmtP(v)},title:{display:true,text:'Retention %'},grid:{display:false}}, },
        }, plugins:[ChartDataLabels],
      });
    }

    // Chart 2: Sales (bars) + Avg Box 1 Discount (line)
    const c2 = `cRT_${chartIdx++}`;
    destroyChart(c2);
    const ctx2 = document.getElementById(c2);
    if(ctx2) {
      STATE.charts[c2] = new Chart(ctx2, {
        type:'bar',
        data:{ labels:last8, datasets:[
          { label:'Sales', data:last8.map(l=>bSales(grpByWeek[l]||[],'ğŸ”´')), backgroundColor:col.bud+'88', borderColor:col.bud, borderWidth:1, yAxisID:'y' },
          { label:'Avg B1 Discount', data:last8.map(l=>bDisc(grpByWeek[l]||[])), type:'line', borderColor:col.act, backgroundColor:'transparent', borderWidth:3, pointRadius:5, pointBackgroundColor:col.act, tension:.3, yAxisID:'y1' },
        ]},
        options:{
          responsive:true, maintainAspectRatio:false, layout:{padding:{top:30}},
          plugins:{ legend:{position:'bottom',labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}}},
            datalabels:{display:true,font:{size:11,weight:'700'},color:function(c){return c.dataset.borderColor||c.dataset.backgroundColor||'#555'},
              formatter:function(v,c){return c.datasetIndex===1?fmtP(v):fmt(v)},anchor:'end',align:'top'}, },
          scales:{ x:{grid:{display:false}}, y:{beginAtZero:true,position:'left',title:{display:true,text:'Sales'},grid:{color:'rgba(0,0,0,.04)'}},
            y1:{beginAtZero:true,position:'right',max:1,ticks:{callback:v=>fmtP(v)},title:{display:true,text:'Discount %'},grid:{display:false}}, },
        }, plugins:[ChartDataLabels],
      });
    }

    // Chart 3: Sales (bars) + App Download % (green) + Tail Mail % (purple)
    const c3 = `cRT_${chartIdx++}`;
    destroyChart(c3);
    const ctx3 = document.getElementById(c3);
    if(ctx3) {
      STATE.charts[c3] = new Chart(ctx3, {
        type:'bar',
        data:{ labels:last8, datasets:[
          { label:'Sales', data:last8.map(l=>bSales(grpByWeek[l]||[],'ğŸ”´')), backgroundColor:col.bud+'88', borderColor:col.bud, borderWidth:1, yAxisID:'y' },
          { label:'App Download %', data:last8.map(l=>avg(grpByWeek[l]||[],'ğŸ”´ App Download %')), type:'line', borderColor:'#27AE60', backgroundColor:'transparent', borderWidth:3, pointRadius:5, pointBackgroundColor:'#27AE60', tension:.3, yAxisID:'y1' },
          { label:'Tail Mail %', data:last8.map(l=>avg(grpByWeek[l]||[],'ğŸ”´ Tail Mail %')), type:'line', borderColor:'#8E44AD', backgroundColor:'transparent', borderWidth:3, borderDash:[6,3], pointRadius:5, pointBackgroundColor:'#8E44AD', tension:.3, yAxisID:'y1' },
        ]},
        options:{
          responsive:true, maintainAspectRatio:false, layout:{padding:{top:30}},
          plugins:{ legend:{position:'bottom',labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}}},
            datalabels:{display:true,font:{size:11,weight:'700'},color:function(c){return c.dataset.borderColor||c.dataset.backgroundColor||'#555'},
              formatter:function(v,c){return c.datasetIndex===0?fmt(v):fmtP(v)},anchor:'end',align:'top'}, },
          scales:{ x:{grid:{display:false}}, y:{beginAtZero:true,position:'left',title:{display:true,text:'Sales'},grid:{color:'rgba(0,0,0,.04)'}},
            y1:{beginAtZero:true,position:'right',max:1,ticks:{callback:v=>fmtP(v)},title:{display:true,text:'%'},grid:{display:false}}, },
        }, plugins:[ChartDataLabels],
      });
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER: TEAM TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Team colour shades per region group (blue shades for team)
const TEAM_SHADES = {
  SOUTH: { LDN:'#1A5276', BRI:'#2980B9', EXE:'#5DADE2' },
  NORTH: { MCR:'#7B241C', NWC:'#C0392B', SCOT:'#E74C3C' },
  'IE F2F Group': { DUB:'#1E8449', CRK:'#27AE60', BF:'#58D68D' },
};

function renderTeam() {
  const recs = getFilteredRegionRecs();
  const col = C[STATE.brand];
  const view = document.getElementById('selView').value;
  const { labels, grouped: byTime } = getTimeAxis(recs);
  const byRegion = groupBy(recs,'âš™ï¸ Region');

  // Overall KPIs â€” team size is avg per week, not summed
  const avgActual = avg(recs,'ğŸ”´ Total Team Size'), avgRequired = avg(recs,'ğŸŸ¡ Team Size Required');
  const avgBA = avg(recs,'ğŸ”´ BA Team Size'), avgRep = avg(recs,'ğŸ”´ Rep Team Size');
  const avgBudgetRep = avg(recs,'ğŸ”µ Rep Team Size p/w');
  const avgStaff = avg(recs,'ğŸ”´ Staffing Performance');
  const teamVar = avgRequired>0?(avgActual-avgRequired)/avgRequired:null;

  document.getElementById('teamKPIs').innerHTML =
    kpi('Avg Team Size',fmt(avgActual),'ğŸŸ¡ Required',fmt(avgRequired),teamVar,'ğŸ‘¥',col.act) +
    kpi('Avg BA',fmt(avgBA),'Brand Ambassadors','',null,'ğŸª',col.bud) +
    kpi('Avg Reps',fmt(avgRep),'ğŸ”µ Budget Reps',fmt(avgBudgetRep),avgBudgetRep>0?(avgRep-avgBudgetRep)/avgBudgetRep:null,'ğŸ·ï¸',col.fcst) +
    kpi('Staffing %',fmtP(avgStaff),'Actual / Forecast','',avgStaff>0?avgStaff-1:null,'âš¡',avgStaff>=0.95?'var(--pos)':'var(--neg)');

  // Build per-region-group sections (same structure as Sales & CPA)
  let html = '';
  let chartIdx = 0;

  for (const grp of REG_GROUP_ORDER) {
    const regions = (REG_IN_GROUP[grp]||[]).filter(r => byRegion[r]);
    if (!regions.length) continue;
    const grpRecs = recs.filter(r => regions.includes(gs(r,'âš™ï¸ Region')));
    const gActual = avg(grpRecs,'ğŸ”´ Total Team Size'), gRequired = avg(grpRecs,'ğŸŸ¡ Team Size Required');
    const gBA = avg(grpRecs,'ğŸ”´ BA Team Size'), gRep = avg(grpRecs,'ğŸ”´ Rep Team Size');
    const gBudgetRep = avg(grpRecs,'ğŸ”µ Rep Team Size p/w');
    const shades = TEAM_SHADES[grp]||{};

    // Section header
    html += `<div class="section-hdr"><h2>${grp}</h2><div class="line"></div></div>`;

    // KPI cards â€” averages per week
    html += `<div class="kpi-row">`;
    html += kpi('Avg Team',fmt(gActual),'ğŸŸ¡ Required',fmt(gRequired),gRequired>0?(gActual-gRequired)/gRequired:null,'ğŸ‘¥',col.act);
    html += kpi('Avg BA',fmt(gBA),'Avg Rep',fmt(gRep),null,'ğŸª',col.bud);
    html += kpi('Budget Reps',fmt(gBudgetRep),'Actual Reps',fmt(gRep),gBudgetRep>0?(gRep-gBudgetRep)/gBudgetRep:null,'ğŸ·ï¸',col.fcst);
    // Per-region mini cards
    for (const reg of regions) {
      const rr = byRegion[reg]||[];
      const rt = avg(rr,'ğŸ”´ Total Team Size'), rq = avg(rr,'ğŸŸ¡ Team Size Required');
      html += kpi(reg,fmt(rt),'Required',fmt(rq),rq>0?(rt-rq)/rq:null,'',shades[reg]||col.act);
    }
    html += `</div>`;

    // Chart 1: Budget Team Size vs Team Size Required vs Total Team Size
    const c1 = `cTM_${chartIdx++}`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” Budget vs Required vs Actual Team Size</h3><div class="chart-wrap"><canvas id="${c1}"></canvas></div></div></div>`;

    // Chart 2: BA Team Size vs Rep Team Size vs Team Size Required
    const c2 = `cTM_${chartIdx++}`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” BA vs Rep vs Required</h3><div class="chart-wrap"><canvas id="${c2}"></canvas></div></div></div>`;

    // Chart 3: Rep Shifts Required vs Forecast Shifts
    const c3 = `cTM_${chartIdx++}`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” Rep Shifts Required vs Forecast Shifts</h3><div class="chart-wrap"><canvas id="${c3}"></canvas></div></div></div>`;

    // Chart 4: SPS Trend
    const c4 = `cTM_${chartIdx++}`;
    html += `<div class="chart-row"><div class="chart-card full"><h3>${grp} â€” SPS Trend</h3><div class="chart-wrap"><canvas id="${c4}"></canvas></div></div></div>`;
  }
  document.getElementById('teamRegionCharts').innerHTML = html;

  // Render charts
  chartIdx = 0;
  for (const grp of REG_GROUP_ORDER) {
    const regions = (REG_IN_GROUP[grp]||[]).filter(r => byRegion[r]);
    if (!regions.length) continue;
    const grpRecs = recs.filter(r => regions.includes(gs(r,'âš™ï¸ Region')));
    const grpByTime = groupBy(grpRecs, document.getElementById('selView').value==='week'?'âš™ï¸ Week':'âš™ï¸ Period');
    const shades = TEAM_SHADES[grp]||{};
    const showLbl = labels.length <= 13;

    // Chart 1: Budget vs Required vs Actual (3 grouped bars)
    const c1 = `cTM_${chartIdx++}`;
    destroyChart(c1);
    const ctx1 = document.getElementById(c1);
    if(ctx1) {
      STATE.charts[c1] = new Chart(ctx1, {
        type:'bar',
        data:{ labels, datasets:[
          { label:'ğŸ”µ Budget Team', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸ”µ Rep Team Size p/w')), backgroundColor:col.bud+'88', borderColor:col.bud, borderWidth:2 },
          { label:'ğŸŸ¡ Required', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸŸ¡ Team Size Required')), backgroundColor:col.fcst+'88', borderColor:col.fcst, borderWidth:2 },
          { label:'ğŸ”´ Actual Team', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸ”´ Total Team Size')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:2 },
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          layout:{ padding:{ top:30 } },
          plugins:{ legend:{ position:'bottom', labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}} },
            datalabels:{ display:showLbl, anchor:'end', align:'top', font:{size:11,weight:'700'}, color:function(c){return c.dataset.borderColor||'#555'}, formatter:v=>v>0?fmt(v):'' },
          },
          scales:{ x:{grid:{display:false},ticks:{font:{size:labels.length>20?8:11}}}, y:{beginAtZero:true,grid:{color:'rgba(0,0,0,.04)'}} },
        },
        plugins:[ChartDataLabels],
      });
    }

    // Chart 2: BA + Rep stacked next to Required
    const c2 = `cTM_${chartIdx++}`;
    destroyChart(c2);
    const ctx2 = document.getElementById(c2);
    if(ctx2) {
      STATE.charts[c2] = new Chart(ctx2, {
        type:'bar',
        data:{ labels, datasets:[
          { label:'ğŸ”´ Rep', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸ”´ Rep Team Size')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:1, stack:'actual' },
          { label:'ğŸ”´ BA', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸ”´ BA Team Size')), backgroundColor:'#1A5276CC', borderColor:'#1A5276', borderWidth:1, stack:'actual' },
          { label:'ğŸŸ¡ Required', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸŸ¡ Team Size Required')), backgroundColor:col.fcst+'88', borderColor:col.fcst, borderWidth:2, stack:'required' },
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          layout:{ padding:{ top:30 } },
          plugins:{ legend:{ position:'bottom', labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}} },
            datalabels:{ display:showLbl, anchor:'end', align:'top', font:{size:11,weight:'700'}, color:function(c){return c.dataset.borderColor||'#555'}, formatter:v=>v>0?fmt(v):'' },
          },
          scales:{ x:{stacked:true,grid:{display:false},ticks:{font:{size:labels.length>20?8:11}}}, y:{stacked:true,beginAtZero:true,grid:{color:'rgba(0,0,0,.04)'}} },
        },
        plugins:[ChartDataLabels],
      });
    }

    // Chart 3: Rep Shifts Required vs Forecast Shifts
    const c3 = `cTM_${chartIdx++}`;
    makeBarChart(c3, labels, [
      { label:'ğŸ”´ Rep Shifts Required', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸ”´ Rep Shifts Required')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:2 },
      { label:'ğŸŸ¡ Forecast Shifts', data:labels.map(t=>sum(grpByTime[t]||[],'ğŸŸ¡ Shifts')), backgroundColor:col.fcst+'88', borderColor:col.fcst, borderWidth:2 },
    ]);

    // Chart 4: SPS trend (lines per region)
    const c4 = `cTM_${chartIdx++}`;
    makeRegionLineChart(c4, labels, regions, grpByTime, r=>bSPS(r,'ğŸ”´'), v=>v?v.toFixed(1):'');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARKET SUMMARY (reusable, rendered at top of every tab)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MKT_LABELS = { UK:'GB', IE:'IE' };
const RG_COLOURS_MKT = { SOUTH:'#10507C', NORTH:'#E74C3C', 'IE F2F Group':'#27AE60' };
let mktChartIdx = 0;

function renderMarketSummary(containerId) {
  const recs = getFilteredRegionRecs();
  const col = C[STATE.brand];
  const container = document.getElementById(containerId);
  if (!container) return;

  // Group by market
  const byMarket = { UK: recs.filter(r=>gs(r,'âš™ï¸ Market')==='UK'), IE: recs.filter(r=>gs(r,'âš™ï¸ Market')==='IE') };
  const markets = ['UK','IE'].filter(m => byMarket[m].length > 0);

  // KPI cards per market
  let html = '<div class="section-hdr"><h2>Market Summary</h2><div class="line"></div></div>';
  html += '<div class="kpi-row">';
  for (const mkt of markets) {
    const mr = byMarket[mkt];
    const s=bSales(mr,'ğŸ”´'), sb=bSales(mr,'ğŸ”µ'), sp=bSpend(mr,'ğŸ”´'), spb=bSpend(mr,'ğŸ”µ');
    const cpa=s>0?sp/s:0, cpab=sb>0?spb/sb:0;
    html += kpi(`${MKT_LABELS[mkt]} Sales`,fmt(s),'ğŸ”µ Budget',fmt(sb),sb>0?(s-sb)/sb:null,'ğŸ“ˆ',col.act);
    html += kpi(`${MKT_LABELS[mkt]} CPA`,fmtCPA(cpa),'ğŸ”µ Budget',fmtCPA(cpab),cpab>0?(cpa-cpab)/cpab:null,'ğŸ¯',col.bud,true);
    html += kpi(`${MKT_LABELS[mkt]} Spend`,fmtC(sp),'ğŸ”µ Budget',fmtC(spb),spb>0?(sp-spb)/spb:null,'ğŸ’°',col.fcst,true);
  }
  html += '</div>';

  // Charts: Sales, Spend, CPA â€” markets as X-axis, region groups as stacked actuals + budget bar
  const cS=`cMkt_${mktChartIdx++}`, cSp=`cMkt_${mktChartIdx++}`, cC=`cMkt_${mktChartIdx++}`;
  html += `<div class="chart-row">
    <div class="chart-card full"><h3>Sales by Market (Region Groups Stacked)</h3><div class="chart-wrap"><canvas id="${cS}"></canvas></div></div>
  </div>`;
  html += `<div class="chart-row">
    <div class="chart-card full"><h3>Spend by Market (Region Groups Stacked)</h3><div class="chart-wrap"><canvas id="${cSp}"></canvas></div></div>
  </div>`;
  html += `<div class="chart-row">
    <div class="chart-card full"><h3>CPA by Market</h3><div class="chart-wrap"><canvas id="${cC}"></canvas></div></div>
  </div>`;

  container.innerHTML = html;

  // Group recs by region group within each market
  const activeRGs = REG_GROUP_ORDER.filter(rg => {
    const regs = REG_IN_GROUP[rg]||[];
    return recs.some(r => regs.includes(gs(r,'âš™ï¸ Region')));
  });

  function rgRecsInMarket(mkt, rg) {
    const regs = REG_IN_GROUP[rg]||[];
    return byMarket[mkt].filter(r => regs.includes(gs(r,'âš™ï¸ Region')));
  }

  // Sales chart: budget (single bar) + actuals stacked by region group
  destroyChart(cS);
  const ctx1 = document.getElementById(cS);
  if (ctx1) {
    STATE.charts[cS] = new Chart(ctx1, {
      type:'bar',
      data:{ labels: markets.map(m=>MKT_LABELS[m]), datasets:[
        { label:'ğŸ”µ Budget', data:markets.map(m=>bSales(byMarket[m],'ğŸ”µ')), backgroundColor:col.bud+'88', borderColor:col.bud, borderWidth:2, stack:'budget' },
        ...activeRGs.map(rg => ({
          label:`ğŸ”´ ${rg}`, data:markets.map(m=>bSales(rgRecsInMarket(m,rg),'ğŸ”´')),
          backgroundColor:(RG_COLOURS_MKT[rg]||'#999')+'CC', borderColor:RG_COLOURS_MKT[rg]||'#999', borderWidth:1, stack:'actual',
        })),
      ]},
      options:{
        responsive:true, maintainAspectRatio:false, layout:{padding:{top:30}},
        plugins:{ legend:{position:'bottom',labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}}},
          datalabels:{display:true,anchor:'end',align:'top',font:{size:13,weight:'700'},color:function(c){return c.dataset.borderColor||'#555'},formatter:v=>v>0?fmt(v):''}, },
        scales:{ x:{stacked:true,grid:{display:false}}, y:{stacked:true,beginAtZero:true,grid:{color:'rgba(0,0,0,.04)'}} },
      }, plugins:[ChartDataLabels],
    });
  }

  // Spend chart
  destroyChart(cSp);
  const ctx2 = document.getElementById(cSp);
  if (ctx2) {
    STATE.charts[cSp] = new Chart(ctx2, {
      type:'bar',
      data:{ labels: markets.map(m=>MKT_LABELS[m]), datasets:[
        { label:'ğŸ”µ Budget', data:markets.map(m=>bSpend(byMarket[m],'ğŸ”µ')), backgroundColor:col.bud+'88', borderColor:col.bud, borderWidth:2, stack:'budget' },
        ...activeRGs.map(rg => ({
          label:`ğŸ”´ ${rg}`, data:markets.map(m=>bSpend(rgRecsInMarket(m,rg),'ğŸ”´')),
          backgroundColor:(RG_COLOURS_MKT[rg]||'#999')+'CC', borderColor:RG_COLOURS_MKT[rg]||'#999', borderWidth:1, stack:'actual',
        })),
      ]},
      options:{
        responsive:true, maintainAspectRatio:false, layout:{padding:{top:30}},
        plugins:{ legend:{position:'bottom',labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}}},
          datalabels:{display:true,anchor:'end',align:'top',font:{size:13,weight:'700'},color:function(c){return c.dataset.borderColor||'#555'},formatter:v=>v>0?fmtC(v):''}, },
        scales:{ x:{stacked:true,grid:{display:false}}, y:{stacked:true,beginAtZero:true,ticks:{callback:v=>fmtC(v)},grid:{color:'rgba(0,0,0,.04)'}} },
      }, plugins:[ChartDataLabels],
    });
  }

  // CPA chart (not stacked â€” grouped bars per market)
  destroyChart(cC);
  const ctx3 = document.getElementById(cC);
  if (ctx3) {
    STATE.charts[cC] = new Chart(ctx3, {
      type:'bar',
      data:{ labels: markets.map(m=>MKT_LABELS[m]), datasets:[
        { label:'ğŸ”µ Budget CPA', data:markets.map(m=>bCPA(byMarket[m],'ğŸ”µ')), backgroundColor:col.bud+'88', borderColor:col.bud, borderWidth:2 },
        { label:'ğŸ”´ Actual CPA', data:markets.map(m=>bCPA(byMarket[m],'ğŸ”´')), backgroundColor:col.act+'CC', borderColor:col.act, borderWidth:2 },
      ]},
      options:{
        responsive:true, maintainAspectRatio:false, layout:{padding:{top:30}},
        plugins:{ legend:{position:'bottom',labels:{usePointStyle:true,padding:14,font:{size:11,weight:'600'}}},
          datalabels:{display:true,anchor:'end',align:'top',font:{size:13,weight:'700'},color:function(c){return c.dataset.borderColor||'#555'},formatter:v=>v>0?fmtCPA(v):''}, },
        scales:{ x:{grid:{display:false}}, y:{beginAtZero:true,ticks:{callback:v=>fmtCPA(v)},grid:{color:'rgba(0,0,0,.04)'}} },
      }, plugins:[ChartDataLabels],
    });
  }
}

function render() {
  mktChartIdx = 0;
  renderMarketSummary('mktSummary_summary');
  renderMarketSummary('mktSummary_sales');
  renderMarketSummary('mktSummary_regions');
  renderMarketSummary('mktSummary_retention');
  renderMarketSummary('mktSummary_team');
  renderSummary();
  renderSales();
  renderRegions();
  renderRetention();
  renderTeam();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTab(id, btn) {
  document.querySelectorAll('.tab-page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+id).classList.add('active');
  if(btn) btn.classList.add('active');
}

function setBrand(b) {
  STATE.brand = b;
  document.body.className = b==='marro'?'theme-marro':b==='combined'?'theme-combined':'';
  document.querySelectorAll('.brand-btn').forEach(btn=>btn.classList.remove('active'));
  event.target.classList.add('active');
  const titles = { butternut:'ğŸ¶ DS Performance Dashboard', marro:'ğŸ± DS Performance Dashboard', combined:'ğŸ¾ DS Performance Dashboard' };
  document.getElementById('title').textContent = titles[b];
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POPULATE FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function populateFilters(records) {
  // Periods
  const periods = new Set(records.map(r=>gs(r,'âš™ï¸ Period')).filter(Boolean));
  const selP = document.getElementById('selPeriod');
  selP.innerHTML = '<option value="all">All Periods</option>';
  PERIODS.filter(p=>periods.has(p)).forEach(p => { const o=document.createElement('option'); o.value=p; o.textContent=p; selP.appendChild(o); });

  // Weeks
  const weeks = new Set(records.map(r=>gs(r,'âš™ï¸ Week')).filter(Boolean));
  const selW = document.getElementById('selWeek');
  selW.innerHTML = '<option value="all">All Weeks</option>';
  WEEKS.filter(w=>weeks.has(w)).forEach(w => { const o=document.createElement('option'); o.value=w; o.textContent=w; selW.appendChild(o); });

  // Region Groups
  const selRG = document.getElementById('selRegionGroup');
  selRG.innerHTML = '<option value="all">All Region Groups</option>';
  REG_GROUP_ORDER.forEach(rg => { const o=document.createElement('option'); o.value=rg; o.textContent=rg; selRG.appendChild(o); });

  // Regions
  const regions = new Set(records.filter(r=>gs(r,'âš™ï¸ Level')==='Region').map(r=>gs(r,'âš™ï¸ Region')).filter(Boolean));
  const allRegs = [...(REG_IN_GROUP.SOUTH||[]), ...(REG_IN_GROUP.NORTH||[]), ...(REG_IN_GROUP['IE F2F Group']||[])];
  const selR = document.getElementById('selRegion');
  selR.innerHTML = '<option value="all">All Regions</option>';
  allRegs.filter(r=>regions.has(r)).forEach(r => { const o=document.createElement('option'); o.value=r; o.textContent=`${REG_EMOJI[r]||''} ${r}`; selR.appendChild(o); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadData() {
  // Check URL param first, then localStorage, then show config
  const urlToken = new URLSearchParams(window.location.search).get('token');
  const token = urlToken || localStorage.getItem('at_token');
  if (urlToken) localStorage.setItem('at_token', urlToken); // save for next visit
  if (!token) { document.getElementById('configPanel').style.display='block'; return; }

  document.getElementById('configPanel').style.display='none';
  document.getElementById('loadingEl').style.display='flex';

  try {
    const [recs2026, recs2025] = await Promise.all([
      fetchRecords(token, '2026'),
      fetchRecords(token, '2025'),
    ]);
    STATE.records = recs2026;
    STATE.records2025 = recs2025;
    console.log(`âœ… Loaded ${recs2026.length} records for 2026, ${recs2025.length} for 2025`);
    populateFilters(STATE.records);
    document.getElementById('loadingEl').style.display='none';
    render();
  } catch(e) {
    console.error(e);
    document.getElementById('loadingEl').innerHTML = `<div style="color:var(--neg);text-align:center"><h3>Error Loading Data</h3><p style="margin-top:8px">${e.message}</p><button onclick="localStorage.removeItem('at_token');location.reload()" style="margin-top:12px;padding:8px 16px;border-radius:6px;border:none;background:var(--hdr);color:var(--hdr-t);cursor:pointer;font-weight:600">Reconfigure</button></div>`;
  }
}

function saveConfig() {
  const token = document.getElementById('cfgToken').value.trim();
  if (!token) return;
  localStorage.setItem('at_token', token);
  loadData();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  loadData();
});
</script>
</body>
</html>
